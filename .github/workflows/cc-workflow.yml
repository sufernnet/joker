name: CCè‡ªåŠ¨æ›´æ–°å·¥ä½œæµ

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´ 06:00 å’Œ 17:00
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00
    - cron: '0 9 * * *'   # UTC 09:00 = åŒ—äº¬æ—¶é—´ 17:00
  
  # å½“CCç›¸å…³æ–‡ä»¶æ›´æ–°æ—¶è§¦å‘
  push:
    paths:
      - 'scripts/cc_merge.py'
      - '.github/workflows/cc-workflow.yml'

jobs:
  cc-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: pip install requests
    
    - name: ğŸ•’ æ˜¾ç¤ºå½“å‰æ—¶é—´
      run: |
        echo "=== CCæ›´æ–°å·¥ä½œæµ ==="
        echo "ä»“åº“: ${{ github.repository }}"
        echo "å¼€å§‹æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "è„šæœ¬ä½ç½®: scripts/cc_merge.py"
        echo "è¾“å‡ºæ–‡ä»¶: CC.m3uï¼ˆæ ¹ç›®å½•ï¼‰"
    
    - name: ğŸš€ è¿è¡ŒCCåˆå¹¶è„šæœ¬
      run: |
        echo "æ­£åœ¨è¿è¡Œ CC åˆå¹¶è„šæœ¬..."
        cd scripts
        python cc_merge.py
        
        echo -e "\n=== æ£€æŸ¥è¾“å‡ºæ–‡ä»¶ ==="
        if [ -f "../CC.m3u" ]; then
          echo "âœ… CC.m3u åˆ›å»ºæˆåŠŸ"
          echo "ä½ç½®: ä»“åº“æ ¹ç›®å½•"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < ../CC.m3u) å­—èŠ‚"
          echo "è¡Œæ•°: $(wc -l < ../CC.m3u)"
          
          echo -e "\n=== å†…å®¹é¢„è§ˆï¼ˆå‰10è¡Œï¼‰==="
          head -10 ../CC.m3u
          echo "..."
          
          echo -e "\n=== é¢‘é“ç»Ÿè®¡ ==="
          echo "HKé¢‘é“: $(grep -c 'group-title="HK"' ../CC.m3u || echo 0)"
          echo "TWé¢‘é“: $(grep -c 'group-title="TW"' ../CC.m3u || echo 0)"
          echo "æ€»é¢‘é“: $(grep -c '^#EXTINF:' ../CC.m3u || echo 0)"
          
          # ç§»åŠ¨åˆ°æ ¹ç›®å½•ï¼ˆå¦‚æœè„šæœ¬è¾“å‡ºåœ¨scriptsç›®å½•ï¼‰
          if [ -f "CC.m3u" ]; then
            mv CC.m3u ../CC.m3u
            echo "å·²å°†CC.m3uç§»åŠ¨åˆ°æ ¹ç›®å½•"
          fi
        else
          # æ£€æŸ¥æ˜¯å¦åœ¨scriptsç›®å½•ä¸­
          if [ -f "CC.m3u" ]; then
            mv CC.m3u ../CC.m3u
            echo "âœ… CC.m3u åˆ›å»ºæˆåŠŸï¼ˆä»scriptsç›®å½•ç§»åŠ¨ï¼‰"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < ../CC.m3u) å­—èŠ‚"
          else
            echo "âŒ é”™è¯¯ï¼šCC.m3u æœªåˆ›å»º"
            exit 1
          fi
        fi
    
    - name: ğŸ”„ è‡ªåŠ¨æäº¤CCæ–‡ä»¶
      if: success()
      run: |
        echo "æ­£åœ¨æäº¤CC.m3uæ›´æ–°..."
        
        # è®¾ç½®Gitç”¨æˆ·
        git config user.email "cc-bot@users.noreply.github.com"
        git config user.name "CCè‡ªåŠ¨æ›´æ–°æœºå™¨äºº"
        
        # æ·»åŠ CC.m3uæ–‡ä»¶ï¼ˆåœ¨æ ¹ç›®å½•ï¼‰
        git add CC.m3u
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --cached --quiet; then
          echo "ğŸ“­ CC.m3uæ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          # æäº¤å˜æ›´
          COMMIT_TIME=$(date -d '+8 hours' '+%Y-%m-%d %H:%M')
          git commit -m "ğŸ¤– CCè‡ªåŠ¨æ›´æ–° [$COMMIT_TIME åŒ—äº¬æ—¶é—´]"
          
          # æ¨é€åˆ°ä»“åº“
          git push origin main
          echo "âœ… CC.m3uå·²æ›´æ–°å¹¶æäº¤"
        fi
    
    - name: ğŸ“Š CCæ›´æ–°æŠ¥å‘Š
      if: always()
      run: |
        echo "=== CCæ›´æ–°æŠ¥å‘Š ==="
        echo "ä»“åº“: ${{ github.repository }}"
        echo "å®Œæˆæ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S åŒ—äº¬æ—¶é—´')"
        echo ""
        echo "ğŸ“ æ–‡ä»¶ä½ç½®:"
        echo "  è„šæœ¬: scripts/cc_merge.py"
        echo "  è¾“å‡º: CC.m3uï¼ˆæ ¹ç›®å½•ï¼‰"
        echo ""
        if [ -f "CC.m3u" ]; then
          SIZE=$(wc -c < CC.m3u)
          LINES=$(wc -l < CC.m3u)
          echo "âœ… CC.m3u çŠ¶æ€:"
          echo "  - å¤§å°: $SIZE å­—èŠ‚"
          echo "  - è¡Œæ•°: $LINES è¡Œ"
          echo "  - HKé¢‘é“: $(grep -c 'group-title="HK"' CC.m3u || echo 0)"
          echo "  - TWé¢‘é“: $(grep -c 'group-title="TW"' CC.m3u || echo 0)"
          echo ""
          echo "ğŸ”— ç›´æ¥é“¾æ¥:"
          echo "  https://raw.githubusercontent.com/${{ github.repository }}/main/CC.m3u"
        else
          echo "âŒ CC.m3u çŠ¶æ€: æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        echo ""
        echo "â° ä¸‹æ¬¡æ›´æ–°æ—¶é—´:"
        echo "  â€¢ åŒ—äº¬æ—¶é—´ 06:00"
        echo "  â€¢ åŒ—äº¬æ—¶é—´ 17:00"
        echo ""
        echo "âš™ï¸ é…ç½®æ–‡ä»¶:"
        echo "  â€¢ å·¥ä½œæµ: .github/workflows/cc-workflow.yml"
        echo "  â€¢ è„šæœ¬: scripts/cc_merge.py"
