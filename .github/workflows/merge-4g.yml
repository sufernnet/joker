name: merge-iptv

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: pip install requests cloudscraper

      # 4️⃣ Fetch and merge playlists
      - name: Fetch and merge
        run: |
          python3 <<'PYTHON_SCRIPT'
import requests
import cloudscraper

# ---------- 国内源 ----------
domestic_lines = []
github_url = "https://raw.githubusercontent.com/xiasufern/AA/main/BB.m3u"
try:
    r = requests.get(github_url, timeout=15)
    r.raise_for_status()
    domestic_lines = r.text.splitlines()
    print(f"国内源共 {len(domestic_lines)} 行")
except Exception as e:
    print("抓取国内源失败:", e)

# ---------- 整合推流 ----------
integrated_lines = ["#EXTM3U"]
iptv_url = "https://www.go-iptv.ggff.net/sub.php?user=PpFQ2ws-1nOoHZWF2d0Jo68g"
try:
    scraper = cloudscraper.create_scraper()
    r = scraper.get(iptv_url, timeout=30)
    r.raise_for_status()
    for line in r.text.splitlines():
        if "整合推流" in line:
            integrated_lines.append(line)
    print(f"整合推流频道数量: {len(integrated_lines)-1}")
except Exception as e:
    print("抓取整合推流失败:", e)
    integrated_lines = ["#EXTM3U"]

# ---------- 合并生成 all-1.m3u ----------
with open("all-1.m3u", "w", encoding="utf-8") as f:
    f.write("#EXTM3U\n\n")
    
    # 国内
    f.write("# ===== 国内 =====\n")
    f.write("\n".join(domestic_lines) + "\n\n")
    
    # 整合推流
    if integrated_lines:
        f.write("# ===== 整合推流 =====\n")
        f.write("\n".join(integrated_lines[1:]))  # 去掉重复 #EXTM3U
        f.write("\n")

print("生成 all-1.m3u 完成！")
PYTHON_SCRIPT

      # 5️⃣ Commit & Push
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add all-1.m3u
          git commit -m "Update merged playlists" || echo "No changes to commit"
          git push
