name: Extract TV Channels

on:
  schedule:
    - cron: '0 6 * * *'   # UTC 6:00 (åŒ—äº¬æ—¶é—´14:00)
    - cron: '0 17 * * *'  # UTC 17:00 (åŒ—äº¬æ—¶é—´æ¬¡æ—¥01:00)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è¿è¡Œ

jobs:
  extract-channels:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Create Python script
        run: |
          cat > tv_extractor.py << 'EOF'
#!/usr/bin/env python3
"""
ä»ŽTVæºä¸­æå–"æ¸¯æ¾³é¢‘é“"å’Œ"ä½“è‚²ä¸–ç•Œ"å¹¶ä¿å­˜ä¸ºEE.m3u
"""

import requests
import re
import os
from datetime import datetime
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# å¸¸é‡å®šä¹‰
SOURCE_URL = "https://raw.githubusercontent.com/yihad168/tv/refs/heads/main/tv.m3u"
EPG_URL = "http://epg.51zmt.top:8000/e.xml"
OUTPUT_FILE = "EE.m3u"

def fetch_m3u_content():
    """èŽ·å–åŽŸå§‹M3Uæ–‡ä»¶å†…å®¹"""
    try:
        logger.info(f"æ­£åœ¨ä»Ž {SOURCE_URL} ä¸‹è½½M3Uæ–‡ä»¶...")
        response = requests.get(SOURCE_URL, timeout=30)
        response.raise_for_status()
        return response.text
    except requests.RequestException as e:
        logger.error(f"ä¸‹è½½M3Uæ–‡ä»¶å¤±è´¥: {e}")
        return None

def extract_channels(content):
    """æå–æ¸¯æ¾³é¢‘é“å’Œä½“è‚²ä¸–ç•Œ"""
    if not content:
        return None
    
    logger.info("å¼€å§‹æå–æŒ‡å®šåˆ†ç»„é¢‘é“...")
    
    # å®šä¹‰è¦æå–çš„åˆ†ç»„
    target_groups = ["æ¸¯æ¾³é¢‘é“", "ä½“è‚²ä¸–ç•Œ"]
    
    # æŒ‰è¡Œåˆ†å‰²å†…å®¹
    lines = content.split('\n')
    extracted_lines = []
    extract_mode = False
    current_group = None
    header_added = False
    
    for i in range(len(lines)):
        line = lines[i].strip()
        
        # å¦‚æžœæ˜¯æ–‡ä»¶å¤´
        if line.startswith("#EXTM3U"):
            # æ·»åŠ EPGä¿¡æ¯åˆ°æ–‡ä»¶å¤´
            if EPG_URL:
                line = f'#EXTM3U url-tvg="{EPG_URL}"'
            if not header_added:
                extracted_lines.append(line)
                header_added = True
            continue
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯åˆ†ç»„è¡Œ
        if line.startswith("#EXTINF"):
            # æå–åˆ†ç»„ä¿¡æ¯
            group_match = re.search(r'group-title="([^"]+)"', line)
            if group_match:
                group_name = group_match.group(1)
                if group_name in target_groups:
                    extract_mode = True
                    current_group = group_name
                    extracted_lines.append(line)
                else:
                    extract_mode = False
                    current_group = None
            elif extract_mode and current_group:
                extracted_lines.append(line)
        
        # å¦‚æžœæ˜¯URLè¡Œä¸”åœ¨æå–æ¨¡å¼ä¸­
        elif extract_mode and line and not line.startswith("#") and current_group:
            extracted_lines.append(line)

    return '\n'.join(extracted_lines) if extracted_lines else None

def save_m3u_file(content):
    """ä¿å­˜M3Uæ–‡ä»¶"""
    if not content:
        logger.error("æ²¡æœ‰å†…å®¹å¯ä¿å­˜")
        return False
    
    try:
        # æ·»åŠ ç”Ÿæˆä¿¡æ¯
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        info_comment = f"# ç”Ÿæˆæ—¶é—´: {timestamp}\n"
        info_comment += f"# æºåœ°å€: {SOURCE_URL}\n"
        info_comment += f"# EPGæº: {EPG_URL}\n"
        info_comment += f"# åŒ…å«åˆ†ç»„: æ¸¯æ¾³é¢‘é“, ä½“è‚²ä¸–ç•Œ\n"
        info_comment += f"# è‡ªåŠ¨æ›´æ–°é¢‘é“åˆ—è¡¨\n\n"
        
        full_content = info_comment + content
        
        with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
            f.write(full_content)
        
        # ç»Ÿè®¡é¢‘é“æ•°é‡
        extinf_count = content.count("#EXTINF")
        logger.info(f"å·²ä¿å­˜åˆ° {OUTPUT_FILE}, å…±æå– {extinf_count} ä¸ªé¢‘é“")
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        file_size = os.path.getsize(OUTPUT_FILE)
        logger.info(f"æ–‡ä»¶å¤§å°: {file_size} å­—èŠ‚")
        
        return True
    except Exception as e:
        logger.error(f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}")
        return False

def main():
    """ä¸»å‡½æ•°"""
    logger.info("=== M3Ué¢‘é“æå–å™¨å¼€å§‹è¿è¡Œ ===")
    
    # èŽ·å–åŽŸå§‹å†…å®¹
    raw_content = fetch_m3u_content()
    if not raw_content:
        logger.error("æ— æ³•èŽ·å–åŽŸå§‹å†…å®¹ï¼Œç¨‹åºé€€å‡º")
        return
    
    # æå–æŒ‡å®šé¢‘é“
    extracted_content = extract_channels(raw_content)
    if not extracted_content:
        logger.error("æœªæ‰¾åˆ°æŒ‡å®šçš„åˆ†ç»„é¢‘é“")
        return
    
    # ä¿å­˜æ–‡ä»¶
    if save_m3u_file(extracted_content):
        logger.info("=== å¤„ç†å®Œæˆ ===")
    else:
        logger.error("=== å¤„ç†å¤±è´¥ ===")

if __name__ == "__main__":
    main()
EOF

      - name: Install dependencies
        run: pip install requests

      - name: Run extraction script
        run: python tv_extractor.py

      - name: Check generated file
        run: |
          if [ -f "EE.m3u" ]; then
            echo "âœ… æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
            echo "ðŸ“Š æ–‡ä»¶ä¿¡æ¯:"
            ls -lh EE.m3u
            echo "ðŸ“ˆ è¡Œæ•°: $(wc -l < EE.m3u)"
            echo "ðŸ“ å‰3è¡Œå†…å®¹:"
            head -3 EE.m3u
          else
            echo "âŒ é”™è¯¯ï¼šEE.m3uæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add EE.m3u
          git commit -m "è‡ªåŠ¨æ›´æ–°EE.m3u $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EE-m3u-file
          path: EE.m3u
          retention-days: 7
