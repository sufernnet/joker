name: Extract Channels
on:
  schedule:
    - cron: '0 6,17 * * *'
  workflow_dispatch:

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - run: |
        pip install requests
        python -c "
import requests, re, datetime
url = 'https://raw.githubusercontent.com/yihad168/tv/refs/heads/main/tv.m3u'
epg = 'http://epg.51zmt.top:8000/e.xml'
r = requests.get(url)
lines = r.text.split('\n')
result = [f'#EXTM3U url-tvg=\"{epg}\"']
extract = False
for i in range(len(lines)):
    line = lines[i]
    if '#EXTM3U' in line:
        continue
    if '#EXTINF' in line and ('港澳频道' in line or '体育世界' in line):
        extract = True
        result.append(line)
    elif extract and line and not line.startswith('#'):
        result.append(line)
        extract = False
    elif '#EXTINF' in line:
        extract = False
with open('EE.m3u', 'w') as f:
    f.write(f'# 生成时间: {datetime.datetime.now()}\\n')
    f.write('\\n'.join(result))
print('Done')
        "
    - run: |
        git config user.name github-actions
        git config user.email actions@github.com
        git add EE.m3u
        git commit -m "Update EE.m3u" || true
        git push
