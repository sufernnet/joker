name: Extract TV Channels

on:
  # 定时触发：每天6:00和17:00 UTC运行
  schedule:
    - cron: '0 6 * * *'   # 每天UTC时间6:00（北京时间14:00）
    - cron: '0 17 * * *'  # 每天UTC时间17:00（北京时间次日01:00）
  
  # 允许手动触发
  workflow_dispatch:
    inputs:
      comment:
        description: '运行备注'
        required: false
        default: '手动触发运行'

jobs:
  extract-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: 运行提取脚本
      run: python tv_extractor.py
      
    - name: 显示文件信息
      run: |
        echo "=== 生成的EE.m3u文件信息 ==="
        if [ -f "EE.m3u" ]; then
          echo "文件大小: $(wc -c < EE.m3u) bytes"
          echo "行数: $(wc -l < EE.m3u)"
          echo "前10行内容:"
          head -10 EE.m3u
        else
          echo "错误：EE.m3u文件未生成"
          exit 1
        fi
        
    - name: 提交更改到仓库
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add EE.m3u
        # 检查是否有更改
        if git diff --staged --quiet; then
          echo "没有更改需要提交"
        else
          git commit -m "自动更新EE.m3u [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push origin HEAD:${{ github.ref }}
        fi
        
    - name: 上传为构建产物
      uses: actions/upload-artifact@v4
      with:
        name: EE-m3u-playlist
        path: EE.m3u
        retention-days: 30
