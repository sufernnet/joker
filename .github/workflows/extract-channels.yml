name: Extract TV Channels

on:
  schedule:
    # 每天6:00和17:00 UTC运行 (对应北京时间14:00和01:00)
    - cron: '0 6,17 * * *'
  workflow_dispatch:  # 允许手动触发
    inputs:
      debug_info:
        description: '调试信息'
        required: false
        default: '手动运行'

jobs:
  extract-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出仓库
      uses: actions/checkout@v4
      with:
        persist-credentials: false
        
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: 运行频道提取脚本
      run: |
        python tv_extractor.py
        
    - name: 验证输出文件
      run: |
        if [ -f "EE.m3u" ]; then
          echo "文件生成成功"
          echo "文件大小: $(wc -l < EE.m3u) 行"
          echo "前5行内容:"
          head -5 EE.m3u
        else
          echo "错误：文件未生成"
          exit 1
        fi
        
    - name: 提交更改
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add EE.m3u
        git commit -m "自动更新EE.m3u文件 - $(date +'%Y-%m-%d %H:%M:%S')" || echo "没有更改可提交"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 上传EE.m3u作为构建产物
      uses: actions/upload-artifact@v4
      with:
        name: EE-m3u-file
        path: EE.m3u
        retention-days: 7
