name: Extract and Validate HK/TW Channels

on:
  schedule:
    - cron: '30 5 * * *'   # UTC 5:30 (åŒ—äº¬æ—¶é—´13:30)
    - cron: '0 17 * * *'   # UTC 17:00 (åŒ—äº¬æ—¶é—´æ¬¡æ—¥01:00)
  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'è·³è¿‡æ’­æ”¾éªŒè¯ï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  extract-and-validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl
      
      - name: Install Python dependencies
        run: pip install requests
      
      - name: Check directory structure
        run: |
          echo "=== æ£€æŸ¥ç›®å½•ç»“æž„ ==="
          pwd
          ls -la
          echo "=== æ£€æŸ¥scriptsç›®å½• ==="
          if [ -d "scripts" ]; then
            echo "scriptsç›®å½•å­˜åœ¨"
            ls -la scripts/
          elif [ -d "joker/scripts" ]; then
            echo "joker/scriptsç›®å½•å­˜åœ¨"
            ls -la joker/scripts/
          else
            echo "æŸ¥æ‰¾æ‰€æœ‰ç›®å½•..."
            find . -type d -name "*script*" -o -type f -name "*.py" | head -20
          fi
      
      - name: Run extraction with validation
        run: |
          echo "=== å¼€å§‹æå–å’ŒéªŒè¯é¢‘é“ ==="
          
          # æ£€æŸ¥å¹¶è¿›å…¥æ­£ç¡®çš„ç›®å½•
          if [ -f "tv_extractor.py" ]; then
            echo "tv_extractor.pyåœ¨å½“å‰ç›®å½•"
            SCRIPT_DIR="."
          elif [ -f "scripts/tv_extractor.py" ]; then
            echo "tv_extractor.pyåœ¨scriptsç›®å½•"
            cd scripts
            SCRIPT_DIR="."
          elif [ -f "joker/scripts/tv_extractor.py" ]; then
            echo "tv_extractor.pyåœ¨joker/scriptsç›®å½•"
            cd joker/scripts
            SCRIPT_DIR="."
          else
            echo "æŸ¥æ‰¾Pythonè„šæœ¬..."
            find . -name "tv_extractor.py" -type f
            exit 1
          fi
          
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x tv_extractor.py
          
          # æ£€æŸ¥æ˜¯å¦è·³è¿‡éªŒè¯
          SKIP_VALIDATION=""
          if [ "${{ github.event.inputs.skip_validation }}" = "true" ]; then
            SKIP_VALIDATION="--skip-validation"
            echo "å°†è·³è¿‡æ’­æ”¾éªŒè¯"
          fi
          
          # è¿è¡ŒPythonè„šæœ¬
          echo "è¿è¡Œæå–è„šæœ¬..."
          python tv_extractor.py $SKIP_VALIDATION
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆæ–‡ä»¶
          if [ -f "EE.m3u" ]; then
            echo "âœ… EE.m3uæ–‡ä»¶å·²ç”Ÿæˆåœ¨å½“å‰ç›®å½•"
            ls -la EE.m3u
          elif [ -f "../EE.m3u" ]; then
            echo "âœ… EE.m3uæ–‡ä»¶å·²ç”Ÿæˆåœ¨ä¸Šçº§ç›®å½•"
            ls -la ../EE.m3u
          else
            echo "âŒ EE.m3uæ–‡ä»¶æœªç”Ÿæˆ"
            # æŸ¥æ‰¾æ‰€æœ‰EE.m3uæ–‡ä»¶
            find . -name "EE.m3u" -type f
            exit 1
          fi
      
      - name: Verify EE.m3u file
        run: |
          echo "=== éªŒè¯EE.m3uæ–‡ä»¶ ==="
          
          # å›žåˆ°ä»“åº“æ ¹ç›®å½•
          cd $GITHUB_WORKSPACE
          
          # æŸ¥æ‰¾EE.m3uæ–‡ä»¶
          if [ -f "EE.m3u" ]; then
            EE_FILE="EE.m3u"
          elif [ -f "scripts/EE.m3u" ]; then
            EE_FILE="scripts/EE.m3u"
          elif [ -f "joker/EE.m3u" ]; then
            EE_FILE="joker/EE.m3u"
          elif [ -f "joker/scripts/EE.m3u" ]; then
            EE_FILE="joker/scripts/EE.m3u"
          else
            echo "æŸ¥æ‰¾EE.m3uæ–‡ä»¶..."
            find . -name "EE.m3u" -type f
            exit 1
          fi
          
          echo "ä½¿ç”¨æ–‡ä»¶: $EE_FILE"
          
          if [ -f "$EE_FILE" ]; then
            echo "âœ… EE.m3uæ–‡ä»¶å­˜åœ¨"
            
            # ç»Ÿè®¡ä¿¡æ¯
            echo ""
            echo "=== é¢‘é“ç»Ÿè®¡ ==="
            total=$(grep -c "#EXTINF" "$EE_FILE" 2>/dev/null || echo "0")
            hk=$(grep -c 'group-title="HK"' "$EE_FILE" 2>/dev/null || echo "0")
            tw=$(grep -c 'group-title="TW"' "$EE_FILE" 2>/dev/null || echo "0")
            
            echo "æ€»é¢‘é“æ•°: $total"
            echo "HKé¢‘é“æ•°: $hk"
            echo "TWé¢‘é“æ•°: $tw"
            
            # æ£€æŸ¥æ–‡ä»¶æ ¼å¼
            echo ""
            echo "=== æ–‡ä»¶æ ¼å¼æ£€æŸ¥ ==="
            if head -1 "$EE_FILE" | grep -q "#EXTM3U"; then
              echo "âœ… æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼ˆä»¥#EXTM3Uå¼€å¤´ï¼‰"
            else
              echo "âŒ æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®"
              exit 1
            fi
            
            # æ£€æŸ¥HKé¢‘é“æŽ’åº
            echo ""
            echo "=== HKé¢‘é“æŽ’åºæ£€æŸ¥ï¼ˆå‰10ä¸ªï¼‰ ==="
            grep -A1 'group-title="HK"' "$EE_FILE" 2>/dev/null | grep -E "^#EXTINF:" | head -10 | sed 's/.*,//' | nl
            
            # æ˜¾ç¤ºæ–‡ä»¶å‰å‡ è¡Œ
            echo ""
            echo "=== æ–‡ä»¶å¤´éƒ¨é¢„è§ˆ ==="
            head -15 "$EE_FILE"
            
          else
            echo "âŒ EE.m3uæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config pull.rebase true
      
      - name: Pull latest changes
        run: |
          echo "=== æ‹‰å–æœ€æ–°å˜æ›´ ==="
          git fetch origin
          git reset --hard origin/main
          git pull origin main --rebase --allow-unrelated-histories || true
      
      - name: Commit changes
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          
          # å›žåˆ°ä»“åº“æ ¹ç›®å½•
          cd $GITHUB_WORKSPACE
          
          # æŸ¥æ‰¾EE.m3uæ–‡ä»¶å¹¶æ·»åŠ 
          if [ -f "EE.m3u" ]; then
            git add EE.m3u
            EE_FILE="EE.m3u"
          elif [ -f "scripts/EE.m3u" ]; then
            git add scripts/EE.m3u
            EE_FILE="scripts/EE.m3u"
          elif [ -f "joker/EE.m3u" ]; then
            git add joker/EE.m3u
            EE_FILE="joker/EE.m3u"
          elif [ -f "joker/scripts/EE.m3u" ]; then
            git add joker/scripts/EE.m3u
            EE_FILE="joker/scripts/EE.m3u"
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°EE.m3uæ–‡ä»¶"
            exit 1
          fi
          
          echo "æ·»åŠ æ–‡ä»¶: $EE_FILE"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          else
            # èŽ·å–å½“å‰æ—¶é—´
            current_time=$(date +'%Y-%m-%d %H:%M:%S')
            
            # èŽ·å–ç»Ÿè®¡ä¿¡æ¯
            if [ -f "$EE_FILE" ]; then
              total=$(grep -c "#EXTINF" "$EE_FILE" 2>/dev/null || echo "0")
              hk=$(grep -c 'group-title="HK"' "$EE_FILE" 2>/dev/null || echo "0")
              tw=$(grep -c 'group-title="TW"' "$EE_FILE" 2>/dev/null || echo "0")
              
              commit_msg="æ›´æ–°EE.m3u - ${total}é¢‘é“(HK:${hk}/TW:${tw}) ${current_time}"
            else
              commit_msg="æ›´æ–°EE.m3u ${current_time}"
            fi
            
            echo "æäº¤æ¶ˆæ¯: $commit_msg"
            git commit -m "$commit_msg"
          fi
      
      - name: Push to repository
        run: |
          echo "=== æŽ¨é€åˆ°ä»“åº“ ==="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æŽ¨é€çš„æäº¤
          if git log origin/main..HEAD --oneline | grep -q .; then
            echo "æ£€æµ‹åˆ°éœ€è¦æŽ¨é€çš„æäº¤"
            echo "æŽ¨é€å˜æ›´åˆ°ä»“åº“..."
            git push origin main --force-with-lease
          else
            echo "æ²¡æœ‰éœ€è¦æŽ¨é€çš„æäº¤"
          fi
      
      - name: Create summary report
        if: always()
        run: |
          echo "## ðŸ“º é¢‘é“æå–æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å›žåˆ°ä»“åº“æ ¹ç›®å½•
          cd $GITHUB_WORKSPACE
          
          # æŸ¥æ‰¾EE.m3uæ–‡ä»¶
          EE_FILE=""
          if [ -f "EE.m3u" ]; then
            EE_FILE="EE.m3u"
          elif [ -f "scripts/EE.m3u" ]; then
            EE_FILE="scripts/EE.m3u"
          elif [ -f "joker/EE.m3u" ]; then
            EE_FILE="joker/EE.m3u"
          elif [ -f "joker/scripts/EE.m3u" ]; then
            EE_FILE="joker/scripts/EE.m3u"
          else
            echo "âŒ **æå–å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "EE.m3uæ–‡ä»¶æœªç”Ÿæˆï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          if [ -n "$EE_FILE" ] && [ -f "$EE_FILE" ]; then
            total=$(grep -c "#EXTINF" "$EE_FILE" 2>/dev/null || echo "0")
            hk=$(grep -c 'group-title="HK"' "$EE_FILE" 2>/dev/null || echo "0")
            tw=$(grep -c 'group-title="TW"' "$EE_FILE" 2>/dev/null || echo "0")
            other=$((total - hk - tw))
            
            echo "âœ… **æå–å®Œæˆ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š é¢‘é“ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| ç±»åˆ« | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| æ€»é¢‘é“æ•° | $total |" >> $GITHUB_STEP_SUMMARY
            echo "| HKé¢‘é“ | $hk |" >> $GITHUB_STEP_SUMMARY
            echo "| TWé¢‘é“ | $tw |" >> $GITHUB_STEP_SUMMARY
            echo "| å…¶ä»–é¢‘é“ | $other |" >> $GITHUB_STEP_SUMMARY
            
            # æ˜¾ç¤ºHKé¢‘é“æŽ’åº
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ HKé¢‘é“æŽ’åºï¼ˆå‰5ä¸ªï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            grep -A1 'group-title="HK"' "$EE_FILE" 2>/dev/null | grep -E "^#EXTINF:" | head -5 | sed 's/.*,//' | while IFS= read -r line; do
              echo "1. $line" >> $GITHUB_STEP_SUMMARY
            done
            
            # æ·»åŠ æ–‡ä»¶é¢„è§ˆé“¾æŽ¥
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ æ–‡ä»¶ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ–‡ä»¶å·²æ›´æ–°**: [$EE_FILE](https://github.com/${{ github.repository }}/blob/main/$EE_FILE)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ›´æ–°æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
            
            # è¿‡æ»¤ä¿¡æ¯
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš™ï¸ è¿‡æ»¤è®¾ç½®" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **HKè¿‡æ»¤**: snaapã€C+ã€ç”„å­ä¸¹å½±è§†é¢‘é“" >> $GITHUB_STEP_SUMMARY
            echo "- **TWè¿‡æ»¤**: å›½ä¼šé¢‘é“ã€åŽŸä½æ°‘ã€liveABCã€UDN TVã€rollorã€MOMOã€å¤§çˆ±ã€å¥½è®¯æ¯ã€Smithã€FOX MOVIESã€PETP" >> $GITHUB_STEP_SUMMARY
            echo "- **HKæŽ’åº**: å‡¤å‡°ä¸­æ–‡ â†’ å‡¤å‡°èµ„è®¯ â†’ å‡¤å‡°é¦™æ¸¯ â†’ å‡¤å‡°ç”µå½± â†’ NOWé¢‘é“ â†’ å…¶ä»–" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "âŒ **æå–å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "EE.m3uæ–‡ä»¶æœªç”Ÿæˆï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi
