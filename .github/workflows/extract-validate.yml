name: Extract and Validate HK/TW Channels

on:
  schedule:
    - cron: '0 6 * * *'   # UTC 6:00
    - cron: '0 18 * * *'  # UTC 18:00
  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'è·³è¿‡æ’­æ”¾éªŒè¯ï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  extract-and-validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl
      
      - name: Install Python dependencies
        run: pip install requests
      
      - name: Check directory structure
        run: |
          echo "=== æ£€æŸ¥ç›®å½•ç»“æž„ ==="
          pwd
          ls -la
          echo "=== æ£€æŸ¥scriptsç›®å½• ==="
          if [ -d "scripts" ]; then
            echo "scriptsç›®å½•å­˜åœ¨"
            ls -la scripts/
          else
            echo "scriptsç›®å½•ä¸å­˜åœ¨ï¼ŒæŸ¥æ‰¾æ‰€æœ‰ç›®å½•..."
            find . -type d -name "*script*" -o -type f -name "*.py"
          fi
      
      - name: Run extraction with validation
        run: |
          echo "=== å¼€å§‹æå–å’ŒéªŒè¯é¢‘é“ ==="
          
          # æ£€æŸ¥å¹¶è¿›å…¥scriptsç›®å½•
          if [ -d "scripts" ]; then
            cd scripts
            echo "å½“å‰ç›®å½•: $(pwd)"
          elif [ -f "tv_extractor.py" ]; then
            echo "tv_extractor.pyåœ¨å½“å‰ç›®å½•"
          else
            echo "æŸ¥æ‰¾Pythonè„šæœ¬..."
            find . -name "tv_extractor.py" -type f
            exit 1
          fi
          
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          if [ -f "tv_extractor.py" ]; then
            chmod +x tv_extractor.py
          else
            echo "é”™è¯¯ï¼šæ‰¾ä¸åˆ°tv_extractor.py"
            exit 1
          fi
          
          # è¿è¡ŒPythonè„šæœ¬
          python tv_extractor.py
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆæ–‡ä»¶
          if [ -f "EE.m3u" ]; then
            echo "âœ… EE.m3uæ–‡ä»¶å·²ç”Ÿæˆåœ¨å½“å‰ç›®å½•"
            ls -la EE.m3u
          elif [ -f "../EE.m3u" ]; then
            echo "âœ… EE.m3uæ–‡ä»¶å·²ç”Ÿæˆåœ¨ä¸Šçº§ç›®å½•"
            ls -la ../EE.m3u
          else
            echo "âŒ EE.m3uæ–‡ä»¶æœªç”Ÿæˆ"
            # æŸ¥æ‰¾æ‰€æœ‰EE.m3uæ–‡ä»¶
            find . -name "EE.m3u" -type f
            exit 1
          fi
      
      - name: Verify EE.m3u file
        run: |
          echo "=== éªŒè¯EE.m3uæ–‡ä»¶ ==="
          
          # æŸ¥æ‰¾EE.m3uæ–‡ä»¶
          if [ -f "EE.m3u" ]; then
            EE_FILE="EE.m3u"
          elif [ -f "scripts/EE.m3u" ]; then
            EE_FILE="scripts/EE.m3u"
          elif [ -f "../EE.m3u" ]; then
            cd ..
            EE_FILE="EE.m3u"
          else
            echo "æŸ¥æ‰¾EE.m3uæ–‡ä»¶..."
            find . -name "EE.m3u" -type f
            exit 1
          fi
          
          echo "ä½¿ç”¨æ–‡ä»¶: $EE_FILE"
          
          if [ -f "$EE_FILE" ]; then
            echo "âœ… EE.m3uæ–‡ä»¶å­˜åœ¨"
            
            # ç»Ÿè®¡ä¿¡æ¯
            echo ""
            echo "=== é¢‘é“ç»Ÿè®¡ ==="
            total=$(grep -c "#EXTINF" "$EE_FILE" 2>/dev/null || echo "0")
            hk=$(grep -c 'group-title="HK"' "$EE_FILE" 2>/dev/null || echo "0")
            tw=$(grep -c 'group-title="TW"' "$EE_FILE" 2>/dev/null || echo "0")
            
            echo "æ€»é¢‘é“æ•°: $total"
            echo "HKé¢‘é“æ•°: $hk"
            echo "TWé¢‘é“æ•°: $tw"
            
            # æ£€æŸ¥æ–‡ä»¶æ ¼å¼
            echo ""
            echo "=== æ–‡ä»¶æ ¼å¼æ£€æŸ¥ ==="
            if head -1 "$EE_FILE" | grep -q "#EXTM3U"; then
              echo "âœ… æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼ˆä»¥#EXTM3Uå¼€å¤´ï¼‰"
            else
              echo "âŒ æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®"
              exit 1
            fi
            
            # æ˜¾ç¤ºå‰å‡ ä¸ªé¢‘é“ç¤ºä¾‹
            echo ""
            echo "=== é¢‘é“ç¤ºä¾‹ï¼ˆå‰5ä¸ªï¼‰ ==="
            grep -A1 "#EXTINF" "$EE_FILE" 2>/dev/null | head -10 || true
            
          else
            echo "âŒ EE.m3uæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Pull latest changes
        run: |
          git pull origin main --rebase || true
      
      - name: Commit and push changes
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          
          # æŸ¥æ‰¾EE.m3uæ–‡ä»¶
          EE_FILE=""
          if [ -f "EE.m3u" ]; then
            EE_FILE="EE.m3u"
            git add EE.m3u
          elif [ -f "scripts/EE.m3u" ]; then
            EE_FILE="scripts/EE.m3u"
            git add scripts/EE.m3u
          fi
          
          if [ -z "$EE_FILE" ]; then
            echo "æœªæ‰¾åˆ°EE.m3uæ–‡ä»¶ï¼ŒæŸ¥æ‰¾æ‰€æœ‰ä½ç½®..."
            find . -name "EE.m3u" -type f | while read file; do
              echo "æ‰¾åˆ°æ–‡ä»¶: $file"
              git add "$file"
            done
          fi
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          else
            # èŽ·å–å½“å‰æ—¶é—´
            current_time=$(date +'%Y-%m-%d %H:%M:%S')
            
            # èŽ·å–ç»Ÿè®¡ä¿¡æ¯
            if [ -n "$EE_FILE" ] && [ -f "$EE_FILE" ]; then
              total=$(grep -c "#EXTINF" "$EE_FILE" 2>/dev/null || echo "0")
              hk=$(grep -c 'group-title="HK"' "$EE_FILE" 2>/dev/null || echo "0")
              tw=$(grep -c 'group-title="TW"' "$EE_FILE" 2>/dev/null || echo "0")
              
              commit_msg="æ›´æ–°EE.m3u - ${total}é¢‘é“(HK:${hk}/TW:${tw}) ${current_time}"
            else
              commit_msg="æ›´æ–°EE.m3u ${current_time}"
            fi
            
            echo "æäº¤æ¶ˆæ¯: $commit_msg"
            git commit -m "$commit_msg"
            
            echo "=== æŽ¨é€åˆ°ä»“åº“ ==="
            git push origin main
          fi
      
      - name: Create summary report
        if: always()
        run: |
          echo "## é¢‘é“æå–æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŸ¥æ‰¾EE.m3uæ–‡ä»¶
          EE_FILE=""
          if [ -f "EE.m3u" ]; then
            EE_FILE="EE.m3u"
          elif [ -f "scripts/EE.m3u" ]; then
            EE_FILE="scripts/EE.m3u"
          else
            # å°è¯•æŸ¥æ‰¾
            EE_FILE=$(find . -name "EE.m3u" -type f | head -1)
          fi
          
          if [ -n "$EE_FILE" ] && [ -f "$EE_FILE" ]; then
            total=$(grep -c "#EXTINF" "$EE_FILE" 2>/dev/null || echo "0")
            hk=$(grep -c 'group-title="HK"' "$EE_FILE" 2>/dev/null || echo "0")
            tw=$(grep -c 'group-title="TW"' "$EE_FILE" 2>/dev/null || echo "0")
            
            echo "âœ… **æå–å®Œæˆ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| ç±»åˆ« | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| æ€»é¢‘é“æ•° | $total |" >> $GITHUB_STEP_SUMMARY
            echo "| HKé¢‘é“ | $hk |" >> $GITHUB_STEP_SUMMARY
            echo "| TWé¢‘é“ | $tw |" >> $GITHUB_STEP_SUMMARY
            
            # æ·»åŠ æ–‡ä»¶é¢„è§ˆé“¾æŽ¥
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **æ–‡ä»¶å·²æ›´æ–°**: [EE.m3u](https://github.com/${{ github.repository }}/blob/main/$EE_FILE)" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "âŒ **æå–å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "EE.m3uæ–‡ä»¶æœªç”Ÿæˆï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi
