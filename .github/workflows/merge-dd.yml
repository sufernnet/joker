name: è‡ªåŠ¨ç”ŸæˆDD.m3uï¼ˆæ¸¯æ¾³å°ä¸“ç‰ˆï¼‰

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´ 06:00 å’Œ 17:00
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00ï¼ˆæ¬¡æ—¥ï¼‰
    - cron: '0 9 * * *'   # UTC 09:00 = åŒ—äº¬æ—¶é—´ 17:00
  
  # å½“è„šæœ¬æ›´æ–°æ—¶ä¹Ÿè§¦å‘
  push:
    paths:
      - 'scripts/merge_dd.py'
      - '.github/workflows/merge-dd.yml'

jobs:
  generate-dd:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: pip install requests
    
    - name: ğŸš€ è¿è¡ŒDDç”Ÿæˆè„šæœ¬
      run: |
        echo "å¼€å§‹ç”ŸæˆDD.m3u..."
        python scripts/merge_dd.py
        
        echo -e "\n=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        if [ -f "DD.m3u" ]; then
          echo "âœ… DD.m3u å·²ç”Ÿæˆ"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < DD.m3u) å­—èŠ‚"
          echo "è¡Œæ•°: $(wc -l < DD.m3u)"
          
          echo -e "\n=== æ–‡ä»¶å†…å®¹é¢„è§ˆ ==="
          echo "å‰5è¡Œ:"
          head -5 DD.m3u
          echo "..."
        else
          echo "âŒ DD.m3u æœªç”Ÿæˆ"
          echo "å½“å‰ç›®å½•:"
          pwd
          ls -la
          exit 1
        fi
    
    - name: ğŸ”„ åŒæ­¥è¿œç¨‹æ›´æ”¹
      run: |
        echo "åŒæ­¥è¿œç¨‹ä»“åº“..."
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        
        # å…ˆæ‹‰å–æœ€æ–°æ›´æ”¹
        git pull origin main --rebase --autostash || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­"
        echo "âœ… åŒæ­¥å®Œæˆ"
    
    - name: ğŸ“¤ æäº¤æ›´æ–°
      run: |
        echo "å‡†å¤‡æäº¤DD.m3u..."
        
        # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
        if [ ! -f "DD.m3u" ]; then
          echo "âŒ DD.m3uä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ·»åŠ æ–‡ä»¶
        git add DD.m3u
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --cached --quiet; then
          echo "ğŸ“­ æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          # æäº¤
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° DD.m3u [$(date +'%Y-%m-%d %H:%M')]"
          echo "æäº¤ä¿¡æ¯: $(git log -1 --oneline)"
          
          # æ¨é€ï¼ˆå¸¦é‡è¯•ï¼‰
          echo "æ¨é€æ›´æ”¹..."
          max_retries=3
          for i in $(seq 1 $max_retries); do
            echo "å°è¯•æ¨é€ (ç¬¬ $i æ¬¡)..."
            if git push origin main; then
              echo "âœ… æ¨é€æˆåŠŸ"
              break
            else
              echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
              sleep 5
              # æ‹‰å–æœ€æ–°å¹¶é‡è¯•
              git pull origin main --rebase
            fi
          done
        fi
    
    - name: ğŸ“Š è¾“å‡ºç»“æœ
      run: |
        echo "=== è¿è¡Œå®Œæˆ ==="
        echo "æ—¶é—´: $(date)"
        echo "æ–‡ä»¶: DD.m3u"
        echo "é“¾æ¥: https://raw.githubusercontent.com/${{ github.repository }}/main/DD.m3u"
        echo "ä¸‹æ¬¡è¿è¡Œ: åŒ—äº¬æ—¶é—´ 06:00 å’Œ 17:00"
