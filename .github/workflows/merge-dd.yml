name: è‡ªåŠ¨ç”ŸæˆDD.m3uï¼ˆæ¸¯æ¾³å°ä¸“ç‰ˆï¼‰

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´ 06:00 å’Œ 17:00
  # UTCæ—¶é—´ = åŒ—äº¬æ—¶é—´ - 8å°æ—¶
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00ï¼ˆæ¬¡æ—¥ï¼‰
    - cron: '0 9 * * *'   # UTC 09:00 = åŒ—äº¬æ—¶é—´ 17:00
  
  # å½“è„šæœ¬æ›´æ–°æ—¶ä¹Ÿè§¦å‘
  push:
    paths:
      - 'scripts/merge_dd.py'
      - '.github/workflows/merge-dd.yml'

jobs:
  generate-dd:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: pip install requests
    
    - name: ğŸ•’ æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯
      run: |
        echo "=== æ—¶é—´ä¿¡æ¯ ==="
        echo "å½“å‰UTCæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "å½“å‰åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "ä¸‹æ¬¡è¿è¡Œ: åŒ—äº¬æ—¶é—´ 06:00 å’Œ 17:00"
        echo "æ¸¯æ¾³å°æº: https://gh-proxy.org/https://raw.githubusercontent.com/Jsnzkpg/Jsnzkpg/Jsnzkpg/Jsnzkpg1"
    
    - name: ğŸš€ è¿è¡ŒDDç”Ÿæˆè„šæœ¬
      run: |
        echo "å¼€å§‹ç”ŸæˆDD.m3u..."
        python scripts/merge_dd.py
        
        echo -e "\n=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        if [ -f "DD.m3u" ]; then
          echo "âœ… DD.m3u å·²ç”Ÿæˆ"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < DD.m3u) å­—èŠ‚"
          echo "è¡Œæ•°: $(wc -l < DD.m3u)"
          echo "ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo -e "\n=== æ–‡ä»¶å†…å®¹é¢„è§ˆ ==="
          echo "å‰10è¡Œ:"
          head -10 DD.m3u
          echo "..."
          
          echo -e "\n=== é¢‘é“ç»Ÿè®¡ ==="
          echo "é¦™æ¸¯é¢‘é“: $(grep -c 'group-title=\"é¦™æ¸¯\"' DD.m3u || echo 0)"
          echo "å°æ¹¾é¢‘é“: $(grep -c 'group-title=\"å°æ¹¾\"' DD.m3u || echo 0)"
          echo "EPGä¿¡æ¯: $(grep -i 'url-tvg' DD.m3u | head -1 || echo 'æœªæ‰¾åˆ°')"
        else
          echo "âŒ DD.m3u æœªç”Ÿæˆ"
          exit 1
        fi
    
    - name: ğŸ”„ åŒæ­¥è¿œç¨‹æ›´æ”¹
      run: |
        echo "åŒæ­¥è¿œç¨‹ä»“åº“..."
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        git pull origin main --rebase --autostash
        echo "âœ… åŒæ­¥å®Œæˆ"
    
    - name: ğŸ“¤ æäº¤æ›´æ–°
      run: |
        echo "å‡†å¤‡æäº¤DD.m3u..."
        
        if [ ! -f "DD.m3u" ]; then
          echo "âŒ DD.m3uä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet DD.m3u; then
          echo "ğŸ“­ DD.m3u æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          exit 0
        fi
        
        # æ·»åŠ å¹¶æäº¤
        git add DD.m3u
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° DD.m3u [$(date -u '+%Y-%m-%d %H:%M UTC')]"
        
        echo "æäº¤ä¿¡æ¯:"
        git log -1 --oneline
        
        # æ¨é€
        git push origin main
        echo "âœ… æäº¤å®Œæˆ"
    
    - name: ğŸ“Š è¾“å‡ºç»“æœ
      if: always()
      run: |
        echo "=== DD.m3uç”Ÿæˆå®Œæˆ ==="
        echo "ğŸ•’ è¿è¡Œå®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ• åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo ""
        echo "ğŸ“… ä¸‹æ¬¡è®¡åˆ’è¿è¡Œ:"
        echo "  â€¢ UTC 22:00 (åŒ—äº¬æ—¶é—´ 06:00)"
        echo "  â€¢ UTC 09:00 (åŒ—äº¬æ—¶é—´ 17:00)"
        echo ""
        echo "ğŸ”— ç”Ÿæˆçš„æ–‡ä»¶:"
        echo "  â€¢ GitHub: https://github.com/${{ github.repository }}/blob/main/DD.m3u"
        echo "  â€¢ Raw: https://raw.githubusercontent.com/${{ github.repository }}/main/DD.m3u"
        echo ""
        echo "âš™ï¸  é…ç½®ä¿¡æ¯:"
        echo "  â€¢ æ¸¯æ¾³å°æº: https://gh-proxy.org/https://raw.githubusercontent.com/Jsnzkpg/Jsnzkpg/Jsnzkpg/Jsnzkpg1"
        echo "  â€¢ BBæº: https://raw.githubusercontent.com/sufernnet/joker/main/BB.m3u"
        echo "  â€¢ æ›´æ–°é¢‘ç‡: æ¯å¤©2æ¬¡ (06:00, 17:00)"
        echo "  â€¢ è‡ªåŠ¨åˆ†ç±»: é¦™æ¸¯ã€å°æ¹¾é¢‘é“"
        echo ""
        if [ -f "DD.m3u" ]; then
          echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
          echo "  âœ… DD.m3u ç”ŸæˆæˆåŠŸ"
          LINES=$(wc -l < DD.m3u)
          SIZE=$(wc -c < DD.m3u)
          HK_COUNT=$(grep -c 'group-title=\"é¦™æ¸¯\"' DD.m3u || echo 0)
          TW_COUNT=$(grep -c 'group-title=\"å°æ¹¾\"' DD.m3u || echo 0)
          echo "    è¡Œæ•°: $LINES"
          echo "    å¤§å°: $SIZE å­—èŠ‚"
          echo "    é¦™æ¸¯é¢‘é“: $HK_COUNT"
          echo "    å°æ¹¾é¢‘é“: $TW_COUNT"
        fi
