name: Update EE.m3u

on:
  schedule:
    - cron: '0 6 * * *'
    - cron: '0 17 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - run: pip install requests
      
      - name: Run minimal script
        working-directory: ./scripts
        run: python tv_extractor.py
      
      - name: Verify
        run: |
          echo "验证结果:"
          if [ -f "EE.m3u" ]; then
            now_news=$(grep -c "NOW新闻台\|NOW新聞台" EE.m3u || echo 0)
            if [ "$now_news" -eq 1 ]; then
              echo "✅ NOW新闻台已去重 (1个)"
            else
              echo "❌ NOW新闻台: $now_news 个 (应=1)"
            fi
            
            # 检查體育世界NOW是否在前
            sports_line=$(grep -n "# 體育世界" EE.m3u | cut -d: -f1)
            if [ -n "$sports_line" ]; then
              now_in_sports=$(tail -n +$sports_line EE.m3u | grep -n "NOW" | head -1 | cut -d: -f1)
              if [ -n "$now_in_sports" ]; then
                if [ "$now_in_sports" -lt 10 ]; then  # NOW在前10行内
                  echo "✅ 體育世界NOW频道在前"
                fi
              fi
            fi
          fi
      
      - name: Commit
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add EE.m3u
          git commit -m "Update EE.m3u" || exit 0
          git pull --rebase origin main
          git push origin main
