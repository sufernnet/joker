name: Extract TV Channels (Fast)

on:
  schedule:
    - cron: '0 6 * * *'   # UTC 6:00
    - cron: '0 17 * * *'  # UTC 17:00
  workflow_dispatch:

jobs:
  extract:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # 设置超时时间
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Run optimized script
        working-directory: ./scripts
        run: python tv_extractor.py
      
      - name: Quick verification
        run: |
          echo "=== 快速验证 ==="
          if [ -f "EE.m3u" ]; then
            echo "✅ EE.m3u生成成功"
            size_kb=$(($(wc -c < EE.m3u) / 1024))
            total=$(grep -c "#EXTINF" EE.m3u || echo 0)
            now_news=$(grep -i "NOW新闻台\|NOW新聞台" EE.m3u | grep -c "#EXTINF" || echo 0)
            
            echo "文件大小: ${size_kb}KB"
            echo "总频道数: $total"
            echo "NOW新闻台: $now_news (应≤1)"
            
            # 检查结构
            echo ""
            echo "=== 文件结构 ==="
            grep "^#" EE.m3u | head -10
          else
            echo "❌ EE.m3u未生成"
            exit 1
          fi
      
      - name: Auto commit
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add EE.m3u
          git commit -m "Update EE.m3u" -m "自动更新 $(date)" || exit 0
          git pull --rebase origin main
          git push origin main
