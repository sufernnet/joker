name: Extract and Sort TV Channels

on:
  schedule:
    - cron: '0 6 * * *'   # UTC 6:00
    - cron: '0 17 * * *'  # UTC 17:00
  workflow_dispatch:

jobs:
  extract:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Run extraction with deduplication
        working-directory: ./scripts
        run: python tv_extractor.py
      
      - name: Verify deduplication and sorting
        run: |
          echo "=== 验证EE.m3u去重和排序 ==="
          if [ -f "EE.m3u" ]; then
            echo "✅ EE.m3u文件存在"
            echo ""
            
            # 统计各类频道数量
            echo "=== 频道分类统计 ==="
            total=$(grep -c "#EXTINF" EE.m3u || echo 0)
            phoenix=$(grep -i "凤凰\|鳳凰" EE.m3u | grep -c "#EXTINF" || echo 0)
            
            # 使用更精确的方法统计NOW频道
            now_hk=$(sed -n '/## NOW频道/,/^##/p' EE.m3u | grep -c "#EXTINF" || echo 0)
            now_sports=$(sed -n '/## NOW体育频道/,/^##/p' EE.m3u | grep -c "#EXTINF" || echo 0)
            sports_total=$(grep -c "體育世界" EE.m3u || echo 0)
            
            echo "总频道数: $total"
            echo "凤凰频道: $phoenix"
            echo "NOW港澳频道: $now_hk"
            echo "NOW体育频道: $now_sports"
            echo "體育世界总数: $sports_total"
            echo ""
            
            # 检查NOW新闻台是否重复
            echo "=== NOW新闻台去重检查 ==="
            now_news_count=$(grep -i "NOW新闻台\|NOW新聞台" EE.m3u | grep -c "#EXTINF" || echo 0)
            if [ "$now_news_count" -le 1 ]; then
              echo "✅ NOW新闻台已去重 ($now_news_count 个)"
            else
              echo "⚠️  发现 $now_news_count 个NOW新闻台，可能存在重复"
            fi
            
            # 验证排序
            echo ""
            echo "=== 排序验证 ==="
            
            # 检查體育世界中NOW是否在最前
            echo "檢查體育世界排序:"
            sports_lines=$(grep -n "體育世界" EE.m3u)
            if echo "$sports_lines" | grep -q "NOW体育频道" && echo "$sports_lines" | grep -q "其他体育频道"; then
              now_sports_line=$(echo "$sports_lines" | grep "NOW体育频道" | head -1 | cut -d: -f1)
              other_sports_line=$(echo "$sports_lines" | grep "其他体育频道" | head -1 | cut -d: -f1)
              
              if [ -n "$now_sports_line" ] && [ -n "$other_sports_line" ]; then
                if [ "$now_sports_line" -lt "$other_sports_line" ]; then
                  echo "✅ 體育世界排序正确: NOW体育频道在其他体育频道之前"
                else
                  echo "⚠️  體育世界排序可能有问题"
                fi
              fi
            fi
            
            echo ""
            echo "=== 文件结构预览 ==="
            echo "文件开头:"
            head -25 EE.m3u
            echo "..."
            echo "体育部分开头:"
            grep -n "體育世界" EE.m3u | head -5
            
          else
            echo "❌ EE.m3u文件不存在"
            exit 1
          fi
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Pull latest changes
        run: git pull origin main --rebase || true
      
      - name: Commit changes
        run: |
          git add EE.m3u
          if git diff --staged --quiet; then
            echo "没有更改需要提交"
          else
            git commit -m "更新EE.m3u - NOW去重+体育NOW优先 $(date +'%Y-%m-%d %H:%M:%S')"
          fi
      
      - name: Push to repository
        run: git push origin main
