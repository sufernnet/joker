name: Generate CC.m3u

on:
  workflow_dispatch:  # 手动触发

jobs:
  generate-cc:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Show directory structure
      run: |
        echo "=== Current directory ==="
        pwd
        echo ""
        echo "=== Files in root ==="
        ls -la
        echo ""
        echo "=== Files in scripts/ ==="
        ls -la scripts/ 2>/dev/null || echo "scripts directory not found"
        
    - name: Create or check BB.m3u
      run: |
        if [ ! -f "BB.m3u" ]; then
          echo "Creating BB.m3u file..."
          echo "#EXTM3U" > BB.m3u
          echo "# Local channels" >> BB.m3u
          echo "本地频道1,http://example.com/channel1" >> BB.m3u
          echo "本地频道2,http://example.com/channel2" >> BB.m3u
          echo "BB.m3u created"
        else
          echo "BB.m3u already exists"
          echo "First 3 lines:"
          head -3 BB.m3u
        fi
        
    - name: Run Python script
      run: |
        echo "Running merge_to_CC.py..."
        python scripts/merge_to_CC.py
        
    - name: Verify CC.m3u creation
      run: |
        echo "=== Checking for CC.m3u ==="
        if [ -f "CC.m3u" ]; then
          echo "✅ SUCCESS: CC.m3u created!"
          echo "File size: $(wc -c < CC.m3u) bytes"
          echo "Line count: $(wc -l < CC.m3u)"
          echo ""
          echo "First 10 lines:"
          echo "----------------"
          head -10 CC.m3u
          echo "----------------"
        else
          echo "❌ FAILED: CC.m3u not found!"
          echo ""
          echo "All files in current directory:"
          ls -la
          echo ""
          echo "Looking for .m3u files:"
          find . -name "*.m3u" -type f 2>/dev/null || echo "No .m3u files found"
          exit 1
        fi
        
    - name: Upload CC.m3u as artifact
      uses: actions/upload-artifact@v4
      with:
        name: cc-m3u-output
        path: CC.m3u
