name: Merge M3U and Generate CC

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00å’Œ12:00å„è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´08:00å’Œ20:00ï¼‰
    - cron: '0 0,12 * * *'
  push:
    paths:
      - 'BB.m3u'  # å½“BB.m3uæ›´æ–°æ—¶ä¹Ÿè§¦å‘

jobs:
  merge-m3u:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Check repository structure
      run: |
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "ç›®å½•ç»“æ„:"
        ls -la
        echo "scriptsç›®å½•å†…å®¹:"
        ls -la scripts/ || echo "scriptsç›®å½•ä¸å­˜åœ¨"
        echo "BB.m3uä½ç½®:"
        find . -name "BB.m3u" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°BB.m3u"
        
    - name: Check for BB.m3u
      id: check_bb
      run: |
        # åœ¨æ ¹ç›®å½•æŸ¥æ‰¾BB.m3u
        if [ -f "BB.m3u" ]; then
          echo "BB.m3uå­˜åœ¨äºæ ¹ç›®å½•"
          echo "bb_exists=true" >> $GITHUB_OUTPUT
          echo "bb_location=./BB.m3u" >> $GITHUB_OUTPUT
          echo "bb_lines=$(wc -l < BB.m3u)" >> $GITHUB_OUTPUT
        elif [ -f "./BB.m3u" ]; then
          echo "BB.m3uå­˜åœ¨äºæ ¹ç›®å½•(./)"
          echo "bb_exists=true" >> $GITHUB_OUTPUT
          echo "bb_location=./BB.m3u" >> $GITHUB_OUTPUT
          echo "bb_lines=$(wc -l < BB.m3u)" >> $GITHUB_OUTPUT
        else
          echo "BB.m3uä¸å­˜åœ¨"
          echo "bb_exists=false" >> $GITHUB_OUTPUT
          echo "bb_lines=0" >> $GITHUB_OUTPUT
          # åˆ›å»ºç©ºçš„BB.m3uæ–‡ä»¶
          echo "#EXTM3U" > BB.m3u
          echo "# Empty BB.m3u created by workflow" >> BB.m3u
        fi
        
    - name: Run merge script from scripts directory
      id: merge
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "å¼€å§‹æ‰§è¡ŒM3Uåˆå¹¶è„šæœ¬..."
        
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ -f "scripts/merge_to_CC.py" ]; then
          echo "æ‰¾åˆ°è„šæœ¬: scripts/merge_to_CC.py"
        else
          echo "é”™è¯¯: æœªæ‰¾åˆ° scripts/merge_to_CC.py"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          exit 1
        fi
        
        # è¿è¡Œè„šæœ¬ï¼ŒæŒ‡å®šæ­£ç¡®çš„è·¯å¾„
        python scripts/merge_to_CC.py \
          --url "https://stymei.sufern001.workers.dev/" \
          --group "ğŸ”¥å…¨ç½‘é€šæ¸¯æ¾³å°" \
          --local "BB.m3u" \
          --output "CC.m3u"
        
        # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        if [ -f "CC.m3u" ]; then
          cc_lines=$(wc -l < CC.m3u)
          echo "CC.m3uå·²åˆ›å»ºï¼Œè¡Œæ•°: $cc_lines"
          echo "cc_lines=$cc_lines" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "CC.m3uåˆ›å»ºå¤±è´¥"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: Display CC.m3u info
      if: steps.merge.outputs.success == 'true'
      run: |
        echo "CC.m3uæ–‡ä»¶ä¿¡æ¯:"
        echo "================"
        head -20 CC.m3u
        echo "..."
        echo "================"
        echo "æ–‡ä»¶å¤§å°: $(wc -c < CC.m3u) å­—èŠ‚"
        echo "æ€»è¡Œæ•°: $(wc -l < CC.m3u)"
        
        # ç»Ÿè®¡åˆ†ç»„æ•°é‡
        genre_count=$(grep -c '#genre#' CC.m3u || true)
        echo "åˆ†ç»„æ•°é‡: $genre_count"
        
        # ç»Ÿè®¡æ¸¯æ¾³å°åˆ†ç»„é¢‘é“æ•°
        hk_tw_count=$(awk '/å…¨ç½‘é€šæ¸¯æ¾³å°,#genre#/{p=1;next} p&&/#genre#/{p=0} p' CC.m3u | grep -c '://' || true)
        echo "å…¨ç½‘é€šæ¸¯æ¾³å°é¢‘é“æ•°: $hk_tw_count"
        
    - name: Commit CC.m3u
      if: steps.merge.outputs.success == 'true'
      run: |
        # é…ç½®git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet CC.m3u 2>/dev/null; then
          echo "CC.m3uæ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          echo "æ£€æµ‹åˆ°CC.m3uå˜åŒ–ï¼Œæäº¤æ›´æ–°"
          git add CC.m3u
          git commit -m "Auto-update: Regenerate CC.m3u [skip ci]"
          
          # å°è¯•æ¨é€ï¼Œå¿½ç•¥é”™è¯¯ï¼ˆå¯èƒ½æ²¡æœ‰æƒé™ï¼‰
          git push origin HEAD:${{ github.ref_name }} || echo "æ¨é€å¤±è´¥ï¼ˆå¯èƒ½æ²¡æœ‰å†™æƒé™ï¼‰"
        fi
        
    - name: Upload CC.m3u as artifact
      uses: actions/upload-artifact@v4
      with:
        name: CC-m3u-file
        path: CC.m3u
        retention-days: 7
        
    - name: Create summary
      if: always()
      run: |
        echo "# M3Uåˆå¹¶ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## æ‰§è¡Œä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å·¥ä½œç›®å½•:** $(pwd)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## æ–‡ä»¶çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- **è¾“å…¥æ–‡ä»¶:** BB.m3u" >> $GITHUB_STEP_SUMMARY
        if ${{ steps.check_bb.outputs.bb_exists == 'true' }}; then
          echo "  - âœ… å­˜åœ¨ (${{ steps.check_bb.outputs.bb_lines }} è¡Œ)" >> $GITHUB_STEP_SUMMARY
        else
          echo "  - âš ï¸ ä¸å­˜åœ¨ï¼Œå·²åˆ›å»ºç©ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **è¾“å‡ºæ–‡ä»¶:** CC.m3u" >> $GITHUB_STEP_SUMMARY
        if ${{ steps.merge.outputs.success == 'true' }}; then
          echo "  - âœ… ç”ŸæˆæˆåŠŸ (${{ steps.merge.outputs.cc_lines }} è¡Œ)" >> $GITHUB_STEP_SUMMARY
        else
          echo "  - âŒ ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **è„šæœ¬ä½ç½®:** scripts/merge_to_CC.py" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## æ•°æ®æº" >> $GITHUB_STEP_SUMMARY
        echo "- **è®¢é˜…é“¾æ¥:** https://stymei.sufern001.workers.dev/" >> $GITHUB_STEP_SUMMARY
        echo "- **æå–åˆ†ç»„:** ğŸ”¥å…¨ç½‘é€šæ¸¯æ¾³å° â†’ å…¨ç½‘é€šæ¸¯æ¾³å°" >> $GITHUB_STEP_SUMMARY
