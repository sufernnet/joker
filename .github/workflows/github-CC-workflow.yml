name: Generate CC.m3u

on:
  workflow_dispatch:  # ÊâãÂä®Ëß¶Âèë
  schedule:
    # ÊØèÂ§©UTC 00:00ËøêË°åÔºàÂåó‰∫¨Êó∂Èó¥08:00Ôºâ
    - cron: '0 0 * * *'

jobs:
  generate-cc:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Ê£ÄÂá∫‰ª£Á†Å
      uses: actions/checkout@v4
      
    - name: üêç ËÆæÁΩÆPython
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: üì¶ ÂÆâË£Ö‰æùËµñ
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: üîç ÊòæÁ§∫ÁõÆÂΩïÁªìÊûÑ
      run: |
        echo "ÂΩìÂâçÁõÆÂΩï: $(pwd)"
        echo ""
        echo "üìÅ ÁõÆÂΩïÁªìÊûÑ:"
        ls -la
        echo ""
        echo "üìÇ scriptsÁõÆÂΩï:"
        ls -la scripts/ || echo "scriptsÁõÆÂΩï‰∏çÂ≠òÂú®"
        echo ""
        echo "üìÑ Êü•ÊâæM3UÊñá‰ª∂:"
        find . -name "*.m3u" -type f 2>/dev/null || echo "Êú™ÊâæÂà∞M3UÊñá‰ª∂"
        
    - name: üìù ÂàõÂª∫ÊàñÊ£ÄÊü•BB.m3u
      run: |
        echo "Ê£ÄÊü•BB.m3uÊñá‰ª∂..."
        if [ ! -f "BB.m3u" ]; then
          echo "ÂàõÂª∫BB.m3uÊñá‰ª∂..."
          cat > BB.m3u << 'EOF'
#EXTM3U
# Êú¨Âú∞È¢ëÈÅìÂàóË°®
# ÂàõÂª∫‰∫é $(date)

# Á§∫‰æãÈ¢ëÈÅì1
Á§∫‰æãÈ¢ëÈÅì1,http://example.com/channel1

# Á§∫‰æãÈ¢ëÈÅì2  
Á§∫‰æãÈ¢ëÈÅì2,http://example.com/channel2
EOF
          echo "‚úÖ BB.m3uÂ∑≤ÂàõÂª∫"
        else
          echo "‚úÖ BB.m3uÂ∑≤Â≠òÂú®"
          echo "Êñá‰ª∂Â§ßÂ∞è: $(wc -c < BB.m3u) bytes"
          echo "Ë°åÊï∞: $(wc -l < BB.m3u)"
        fi
        
    - name: üöÄ ËøêË°åPythonËÑöÊú¨
      id: run-script
      run: |
        echo "ÂºÄÂßãÊâßË°åÂêàÂπ∂ËÑöÊú¨..."
        echo ""
        
        # Á°Æ‰øùËÑöÊú¨ÂèØÊâßË°å
        chmod +x scripts/merge_to_CC.py
        
        # ËøêË°åËÑöÊú¨
        python scripts/merge_to_CC.py
        
        echo ""
        echo "ËÑöÊú¨ÊâßË°åÂÆåÊàê"
        
    - name: ‚úÖ È™åËØÅCC.m3uÁîüÊàê
      run: |
        echo "È™åËØÅËæìÂá∫Êñá‰ª∂..."
        echo ""
        
        if [ -f "CC.m3u" ]; then
          echo "üéâ CC.m3u ÁîüÊàêÊàêÂäü!"
          echo ""
          echo "üìä Êñá‰ª∂‰ø°ÊÅØ:"
          echo "  ‰ΩçÁΩÆ: $(pwd)/CC.m3u"
          echo "  Â§ßÂ∞è: $(wc -c < CC.m3u) bytes"
          echo "  Ë°åÊï∞: $(wc -l < CC.m3u)"
          echo ""
          echo "üìã Êñá‰ª∂ÂÜÖÂÆπÈ¢ÑËßà:"
          echo "----------------------------------------"
          head -20 CC.m3u
          echo "----------------------------------------"
          echo ""
          
          # ÁªüËÆ°‰ø°ÊÅØ
          echo "üìà ÁªüËÆ°‰ø°ÊÅØ:"
          channel_count=$(grep -c '://' CC.m3u || true)
          echo "  ÊÄªÈ¢ëÈÅìÊï∞: $channel_count"
          
          hk_count=$(grep -c 'Ê∏ØÊæ≥Âè∞' CC.m3u || true)
          echo "  Ê∏ØÊæ≥Âè∞Áõ∏ÂÖ≥Ë°åÊï∞: $hk_count"
          
          # Á°Æ‰øùÊúâÂÜÖÂÆπ
          if [ $(wc -l < CC.m3u) -lt 5 ]; then
            echo "‚ö†Ô∏è  Ë≠¶Âëä: Êñá‰ª∂ÂÜÖÂÆπÂèØËÉΩËøáÂ∞ë"
            echo "ÂÆåÊï¥ÂÜÖÂÆπ:"
            cat CC.m3u
          fi
        else
          echo "‚ùå CC.m3u Êú™ÁîüÊàê!"
          echo ""
          echo "ÂΩìÂâçÁõÆÂΩïÊñá‰ª∂:"
          ls -la
          echo ""
          echo "Â∞ùËØïÊü•ÊâæÊâÄÊúâÊñá‰ª∂:"
          find . -type f -name "*.m3u" 2>/dev/null || echo "Êú™ÊâæÂà∞M3UÊñá‰ª∂"
          exit 1
        fi
        
    - name: üíæ ‰øùÂ≠òCC.m3u‰∏∫Â∑•‰ª∂
      uses: actions/upload-artifact@v4
      with:
        name: CC-m3u-file
        path: CC.m3u
        retention-days: 7
        
    - name: üì§ Êé®ÈÄÅÂà∞‰ªìÂ∫ì
      run: |
        echo "ÈÖçÁΩÆGit..."
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        echo "Ê∑ªÂä†CC.m3u..."
        git add CC.m3u
        
        echo "Ê£ÄÊü•Áä∂ÊÄÅ..."
        git status
        
        if git diff --cached --quiet; then
          echo "Ê≤°ÊúâÂèòÂåñÈúÄË¶ÅÊèê‰∫§"
        else
          echo "Êèê‰∫§Êõ¥Êîπ..."
          git commit -m "ü§ñ Ëá™Âä®Êõ¥Êñ∞CC.m3u $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Êé®ÈÄÅÊõ¥Êîπ..."
          git push
          echo "‚úÖ Êé®ÈÄÅÂÆåÊàê"
        fi
        
    - name: üìä ÁîüÊàêÊä•Âëä
      if: always()
      run: |
        echo "## üìã ÊâßË°åÊä•Âëä" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üìÖ Âü∫Êú¨‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
        echo "- **ËøêË°åÊó∂Èó¥:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Â∑•‰ΩúÁõÆÂΩï:** $(pwd)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "CC.m3u" ]; then
          echo "### ‚úÖ ÊàêÂäüÁîüÊàê CC.m3u" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Êñá‰ª∂‰ø°ÊÅØ:**" >> $GITHUB_STEP_SUMMARY
          echo "- Â§ßÂ∞è: $(wc -c < CC.m3u) bytes" >> $GITHUB_STEP_SUMMARY
          echo "- Ë°åÊï∞: $(wc -l < CC.m3u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ÂÜÖÂÆπÈ¢ÑËßà:**" >> $GITHUB_STEP_SUMMARY
          echo '```m3u' >> $GITHUB_STEP_SUMMARY
          head -10 CC.m3u >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå ÁîüÊàêÂ§±Ë¥•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Êú™ËÉΩÁîüÊàê CC.m3u Êñá‰ª∂" >> $GITHUB_STEP_SUMMARY
        fi
