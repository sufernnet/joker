name: Generate CC.m3u

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰
    - cron: '0 0 * * *'
  push:
    paths:
      - 'BB.m3u'
      - 'scripts/merge_to_CC.py'

jobs:
  generate-cc:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æ·»åŠ å†™å…¥æƒé™
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: ğŸ” æ£€æŸ¥æ–‡ä»¶ç»“æ„
      run: |
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "å®Œæ•´è·¯å¾„:"
        pwd
        echo ""
        echo "ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        echo "scriptsç›®å½•:"
        ls -la scripts/ || echo "scriptsç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "æŸ¥æ‰¾BB.m3u:"
        find . -name "BB.m3u" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°BB.m3u"
        
    - name: ğŸ“„ ç¡®ä¿BB.m3uå­˜åœ¨
      run: |
        if [ ! -f "BB.m3u" ]; then
          echo "åˆ›å»ºé»˜è®¤BB.m3uæ–‡ä»¶..."
          cat > BB.m3u << 'EOF'
#EXTM3U
# BB.m3u - æœ¬åœ°é¢‘é“åˆ—è¡¨
# åˆ›å»ºæ—¶é—´: $(date)
# è¿™æ˜¯ä¸€ä¸ªç©ºçš„æœ¬åœ°M3Uæ–‡ä»¶
EOF
          echo "âœ… å·²åˆ›å»ºBB.m3u"
        else
          echo "âœ… BB.m3uå·²å­˜åœ¨"
          echo "BB.m3uå†…å®¹é¢„è§ˆ:"
          head -5 BB.m3u
        fi
        
    - name: ğŸš€ è¿è¡Œåˆå¹¶è„šæœ¬
      id: run-script
      run: |
        echo "å¼€å§‹æ‰§è¡ŒM3Uåˆå¹¶è„šæœ¬..."
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo ""
        
        # è¿è¡Œè„šæœ¬
        python scripts/merge_to_CC.py \
          --url "https://stymei.sufern001.workers.dev/" \
          --group "ğŸ”¥å…¨ç½‘é€šæ¸¯æ¾³å°" \
          --local "BB.m3u" \
          --output "CC.m3u"
        
        echo ""
        echo "è„šæœ¬æ‰§è¡Œå®Œæˆ"
        
    - name: âœ… éªŒè¯CC.m3uç”Ÿæˆ
      run: |
        echo "éªŒè¯CC.m3uæ–‡ä»¶ç”Ÿæˆ..."
        echo ""
        
        if [ -f "CC.m3u" ]; then
          echo "âœ… CC.m3u ç”ŸæˆæˆåŠŸ!"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          echo "  ä½ç½®: $(pwd)/CC.m3u"
          echo "  å¤§å°: $(wc -c < CC.m3u) å­—èŠ‚"
          echo "  è¡Œæ•°: $(wc -l < CC.m3u)"
          echo ""
          echo "å‰15è¡Œå†…å®¹:"
          echo "----------------------------------------"
          head -15 CC.m3u
          echo "----------------------------------------"
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹
          channel_count=$(grep -c '://' CC.m3u || true)
          echo "é¢‘é“æ•°é‡: $channel_count"
          
          # æ£€æŸ¥æ¸¯æ¾³å°åˆ†ç»„
          if grep -q "å…¨ç½‘é€šæ¸¯æ¾³å°" CC.m3u; then
            echo "âœ… åŒ…å«'å…¨ç½‘é€šæ¸¯æ¾³å°'åˆ†ç»„"
          else
            echo "âš ï¸  ä¸åŒ…å«'å…¨ç½‘é€šæ¸¯æ¾³å°'åˆ†ç»„"
          fi
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "cc_created=true" >> $GITHUB_OUTPUT
          echo "cc_lines=$(wc -l < CC.m3u)" >> $GITHUB_OUTPUT
        else
          echo "âŒ CC.m3u ç”Ÿæˆå¤±è´¥!"
          echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          echo ""
          echo "å°è¯•æŸ¥æ‰¾CC.m3u:"
          find . -name "CC.m3u" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°CC.m3u"
          
          echo "cc_created=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: ğŸ“¤ ä¸Šä¼ CC.m3uä¸ºå·¥ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: CC-m3u-output
        path: CC.m3u
        retention-days: 7
        
    - name: ğŸ’¾ æäº¤CC.m3uåˆ°ä»“åº“
      if: steps.run-script.outputs.cc_created == 'true'
      run: |
        echo "å‡†å¤‡æäº¤CC.m3uåˆ°GitHubä»“åº“..."
        
        # é…ç½®git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet CC.m3u 2>/dev/null || [ ! -f ".git/index" ]; then
          echo "CC.m3uæ²¡æœ‰å˜åŒ–æˆ–è¿™æ˜¯é¦–æ¬¡è¿è¡Œ"
          # å¼ºåˆ¶æ·»åŠ æ–‡ä»¶
          git add CC.m3u
          git status
        else
          echo "æ£€æµ‹åˆ°CC.m3uæœ‰å˜åŒ–"
          git add CC.m3u
          git status
        fi
        
        # æäº¤æ›´æ”¹
        if ! git diff --cached --quiet; then
          echo "æäº¤æ›´æ”¹..."
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: ç”ŸæˆCC.m3uæ–‡ä»¶ [skip ci]
          
          æ¥æº: https://stymei.sufern001.workers.dev/
          æå–åˆ†ç»„: ğŸ”¥å…¨ç½‘é€šæ¸¯æ¾³å°
          ç”Ÿæˆæ—¶é—´: $(date)
          è¡Œæ•°: $(wc -l < CC.m3u)"
          
          echo "æ¨é€æ›´æ”¹..."
          git push
          echo "âœ… æäº¤æˆåŠŸ!"
        else
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        fi
        
    - name: ğŸ“Š ç”Ÿæˆå·¥ä½œæµæ€»ç»“
      if: always()
      run: |
        echo "# CC.m3u ç”ŸæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“… æ‰§è¡Œä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å·¥ä½œç›®å½•:** $(pwd)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“ æ–‡ä»¶çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        if [ -f "BB.m3u" ]; then
          bb_lines=$(wc -l < BB.m3u)
          echo "- **BB.m3u:** âœ… å­˜åœ¨ ($bb_lines è¡Œ)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **BB.m3u:** âš ï¸ ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "CC.m3u" ]; then
          cc_lines=$(wc -l < CC.m3u)
          cc_size=$(wc -c < CC.m3u)
          echo "- **CC.m3u:** âœ… ç”ŸæˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "  - è¡Œæ•°: $cc_lines" >> $GITHUB_STEP_SUMMARY
          echo "  - å¤§å°: $cc_size å­—èŠ‚" >> $GITHUB_STEP_SUMMARY
          
          # ç»Ÿè®¡ä¿¡æ¯
          genre_count=$(grep -c '#genre#' CC.m3u || true)
          channel_count=$(grep -c '://' CC.m3u || true)
          echo "  - åˆ†ç»„æ•°: $genre_count" >> $GITHUB_STEP_SUMMARY
          echo "  - é¢‘é“æ•°: $channel_count" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **CC.m3u:** âŒ ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ”— æ•°æ®æº" >> $GITHUB_STEP_SUMMARY
        echo "- **è®¢é˜…é“¾æ¥:** https://stymei.sufern001.workers.dev/" >> $GITHUB_STEP_SUMMARY
        echo "- **æå–åˆ†ç»„:** ğŸ”¥å…¨ç½‘é€šæ¸¯æ¾³å° â†’ å…¨ç½‘é€šæ¸¯æ¾³å°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "CC.m3u" ]; then
          echo "## ğŸ“‹ æ–‡ä»¶é¢„è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo '```m3u' >> $GITHUB_STEP_SUMMARY
          head -10 CC.m3u >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
