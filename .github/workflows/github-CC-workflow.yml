name: ç”ŸæˆCC.m3uï¼ˆåŒåˆ†ç»„åˆå¹¶ç‰ˆï¼‰

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00
    - cron: '0 9 * * *'   # UTC 09:00 = åŒ—äº¬æ—¶é—´ 17:00

jobs:
  generate-cc:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: pip install requests
    
    - name: ğŸ” æ£€æŸ¥ç¯å¢ƒ
      run: |
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        echo "BB.m3uçŠ¶æ€:"
        if [ -f "BB.m3u" ]; then
          echo "âœ… å­˜åœ¨ ($(wc -l < BB.m3u) è¡Œ)"
        else
          echo "âš ï¸  ä¸å­˜åœ¨ï¼Œè„šæœ¬å°†è‡ªåŠ¨åˆ›å»º"
        fi
    
    - name: ğŸš€ è¿è¡Œåˆå¹¶è„šæœ¬
      id: run-script
      run: |
        echo "å¼€å§‹æ‰§è¡Œè„šæœ¬..."
        python scripts/merge_to_CC.py
        
        if [ -f "CC.m3u" ]; then
          echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ"
          echo "success=true" >> $GITHUB_OUTPUT
          echo "lines=$(wc -l < CC.m3u)" >> $GITHUB_OUTPUT
          echo "channels=$(grep -c 'group-title=\"å…¨ç½‘é€šæ¸¯æ¾³å°\"' CC.m3u || echo 0)" >> $GITHUB_OUTPUT
        else
          echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ğŸ“Š æ˜¾ç¤ºç»“æœ
      if: steps.run-script.outputs.success == 'true'
      run: |
        echo "=== ç”Ÿæˆç»“æœ ==="
        echo "æ–‡ä»¶: CC.m3u"
        echo "è¡Œæ•°: ${{ steps.run-script.outputs.lines }}"
        echo "æ¸¯æ¾³å°é¢‘é“æ•°: ${{ steps.run-script.outputs.channels }}"
        echo ""
        echo "=== æ–‡ä»¶å¤´ ==="
        head -20 CC.m3u
    
    - name: ğŸ“¤ æäº¤æ›´æ–°
      if: steps.run-script.outputs.success == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add CC.m3u
        
        if git diff --cached --quiet; then
          echo "ğŸ“­ æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°CC.m3u [$(date +'%Y-%m-%d %H:%M')]
          
          - æå–åˆ†ç»„: ğŸ”¥å…¨ç½‘é€šæ¸¯æ¾³å°, ğŸ”®æ¸¯æ¾³å°ç›´æ’­
          - åˆå¹¶åˆ†ç»„: å…¨ç½‘é€šæ¸¯æ¾³å°
          - æ¸¯æ¾³å°é¢‘é“: ${{ steps.run-script.outputs.channels }}ä¸ª"
          git push
          echo "âœ… å·²æäº¤å¹¶æ¨é€"
        fi
    
    - name: ğŸ’¾ ä¸Šä¼ äº§ç‰©
      if: steps.run-script.outputs.success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: CC.m3u
        path: CC.m3u
        retention-days: 7
    
    - name: ğŸ“‹ ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        echo "# CC.m3u ç”ŸæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "CC.m3u" ]; then
          echo "## âœ… ç”ŸæˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“Š ç»Ÿè®¡ä¿¡æ¯**" >> $GITHUB_STEP_SUMMARY
          echo "- æ€»è¡Œæ•°: $(wc -l < CC.m3u)" >> $GITHUB_STEP_SUMMARY
          echo "- æ¸¯æ¾³å°é¢‘é“æ•°: $(grep -c 'group-title=\"å…¨ç½‘é€šæ¸¯æ¾³å°\"' CC.m3u || echo 0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ğŸ”— ç›´é“¾åœ°å€**" >> $GITHUB_STEP_SUMMARY
          echo "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/CC.m3u" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ğŸ“ æ–‡ä»¶é¢„è§ˆ**" >> $GITHUB_STEP_SUMMARY
          echo '```m3u' >> $GITHUB_STEP_SUMMARY
          head -8 CC.m3u >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥è„šæœ¬æ‰§è¡Œæ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
