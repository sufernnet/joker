name: ç”ŸæˆCC.m3uï¼ˆæ¯æ—¥ä¸¤æ¬¡è‡ªåŠ¨æ›´æ–°ï¼‰

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    # åŒ—äº¬æ—¶é—´ 06:00 (UTC 22:00 å‰ä¸€å¤©)
    - cron: '0 22 * * *'
    # åŒ—äº¬æ—¶é—´ 17:30 (UTC 09:30)
    - cron: '30 9 * * *'

# æ·»åŠ ä»“åº“å†™å…¥æƒé™
permissions:
  contents: write  # å…³é”®ï¼šå…è®¸å·¥ä½œæµå†™å…¥ä»“åº“

jobs:
  generate-cc:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ï¼ˆä½¿ç”¨tokenï¼‰
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨GITHUB_TOKEN
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
    
    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: pip install requests
    
    - name: ğŸ” æ£€æŸ¥ç¯å¢ƒ
      run: |
        echo "=== å·¥ä½œæµå¯åŠ¨ä¿¡æ¯ ==="
        echo "æ—¶é—´: $(date)"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo ""
        echo "=== æ–‡ä»¶çŠ¶æ€ ==="
        if [ -f "BB.m3u" ]; then
          echo "âœ… BB.m3u å­˜åœ¨ ($(wc -l < BB.m3u) è¡Œ)"
        else
          echo "âš ï¸  BB.m3u ä¸å­˜åœ¨ï¼Œè„šæœ¬å°†è‡ªåŠ¨åˆ›å»º"
        fi
        echo ""
        echo "=== å®šæ—¶è®¾ç½® ==="
        echo "è‡ªåŠ¨è¿è¡Œæ—¶é—´: åŒ—äº¬æ—¶é—´ 06:00 å’Œ 17:30"
        echo "UTCå¯¹åº”æ—¶é—´: 22:00(å‰æ—¥) å’Œ 09:30"
    
    - name: ğŸš€ è¿è¡Œåˆå¹¶è„šæœ¬
      id: run-script
      run: |
        echo "å¼€å§‹æ‰§è¡Œè„šæœ¬..."
        echo "å½“å‰UTCæ—¶é—´: $(date -u)"
        echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        python scripts/merge_to_CC.py
        
        if [ -f "CC.m3u" ]; then
          echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ"
          echo "success=true" >> $GITHUB_OUTPUT
          echo "lines=$(wc -l < CC.m3u)" >> $GITHUB_OUTPUT
          echo "channels=$(grep -c 'group-title=\"å…¨ç½‘é€šæ¸¯æ¾³å°\"' CC.m3u || echo 0)" >> $GITHUB_OUTPUT
          echo "size=$(wc -c < CC.m3u)" >> $GITHUB_OUTPUT
        else
          echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ğŸ“Š æ˜¾ç¤ºç”Ÿæˆç»“æœ
      if: steps.run-script.outputs.success == 'true'
      run: |
        echo "=== ç”Ÿæˆç»“æœ ==="
        echo "æ–‡ä»¶: CC.m3u"
        echo "è¡Œæ•°: ${{ steps.run-script.outputs.lines }}"
        echo "å¤§å°: ${{ steps.run-script.outputs.size }} å­—èŠ‚"
        echo "æ¸¯æ¾³å°é¢‘é“æ•°: ${{ steps.run-script.outputs.channels }}"
        echo ""
        echo "=== æ–‡ä»¶å¤´éƒ¨é¢„è§ˆ ==="
        head -20 CC.m3u
        echo ""
        echo "=== è¿‡æ»¤ç»Ÿè®¡ ==="
        echo "å·²å‰”é™¤é¢‘é“: å‡¤å‡°ç”µå½±ã€C+ã€MoMoTVã€DAZN1ã€DAZN2ã€ELEVENä½“è‚²1ã€ELEVENä½“è‚²2ã€çˆ±å¥‡è‰º"
        echo "åŠå…¶ä»–é»‘åå•é¢‘é“"
    
    - name: ğŸ”„ æ‹‰å–æœ€æ–°æ›´æ”¹ï¼ˆé¿å…å†²çªï¼‰
      if: steps.run-script.outputs.success == 'true'
      run: |
        echo "æ‹‰å–æœ€æ–°ä»“åº“æ›´æ”¹..."
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # æ‹‰å–æœ€æ–°æ›´æ”¹ï¼Œä½¿ç”¨rebaseé¿å…å†²çª
        git pull origin ${{ github.ref_name }} --rebase --autostash || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
        echo "âœ… åŒæ­¥å®Œæˆ"
    
    - name: ğŸ“¤ æäº¤æ›´æ–°ï¼ˆå®‰å…¨æ–¹å¼ï¼‰
      if: steps.run-script.outputs.success == 'true'
      run: |
        echo "å‡†å¤‡æäº¤æ›´æ–°..."
        
        # å†æ¬¡é…ç½®gitï¼ˆç¡®ä¿é…ç½®å­˜åœ¨ï¼‰
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç¡®å®æœ‰å˜åŒ–
        if git status --porcelain | grep -q "CC.m3u"; then
          echo "æ£€æµ‹åˆ°CC.m3uæœ‰å˜åŒ–"
          
          # æ·»åŠ æ–‡ä»¶
          git add CC.m3u
          
          # è·å–å½“å‰åŒ—äº¬æ—¶é—´
          beijing_time=$(date -d '+8 hours' '+%Y-%m-%d %H:%M')
          
          # æäº¤
          commit_msg="ğŸ¤– è‡ªåŠ¨æ›´æ–°CC.m3u [${beijing_time}]
          
          æ›´æ–°å†…å®¹:
          - æå–åˆ†ç»„: ğŸ”¥å…¨ç½‘é€šæ¸¯æ¾³å°, ğŸ”®æ¸¯æ¾³å°ç›´æ’­
          - åˆå¹¶åˆ†ç»„: å…¨ç½‘é€šæ¸¯æ¾³å°
          - é¢‘é“æ•°é‡: ${{ steps.run-script.outputs.channels }}ä¸ª
          - æ–‡ä»¶å¤§å°: ${{ steps.run-script.outputs.size }}å­—èŠ‚
          - è¿‡æ»¤é¢‘é“: å‡¤å‡°ç”µå½±ã€C+ã€MoMoTVã€DAZNã€ELEVENä½“è‚²ã€çˆ±å¥‡è‰ºç­‰
          - è¿è¡Œæ—¶é—´: åŒ—äº¬æ—¶é—´ 06:00 / 17:30"
          
          echo "æäº¤ä¿¡æ¯:"
          echo "$commit_msg"
          
          # ä½¿ç”¨å¤šè¡Œæäº¤ä¿¡æ¯
          git commit -m "$commit_msg"
          
          # æ¨é€æ›´æ”¹
          echo "æ¨é€æ›´æ”¹..."
          git push origin ${{ github.ref_name }}
          echo "âœ… æäº¤å¹¶æ¨é€æˆåŠŸ"
        else
          echo "ğŸ“­ CC.m3uæ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤"
        fi
    
    - name: ğŸ’¾ ä¸Šä¼ äº§ç‰©ï¼ˆå¤‡ç”¨ï¼‰
      if: steps.run-script.outputs.success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: CC.m3u-$(date -u +'%Y%m%d-%H%M%S')
        path: CC.m3u
        retention-days: 7
    
    - name: ğŸ“‹ ç”Ÿæˆå·¥ä½œæŠ¥å‘Š
      if: always()
      run: |
        echo "# CC.m3u è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“… æ‰§è¡Œä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´ (UTC):** $(date -u '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´ (åŒ—äº¬):** $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¸‹æ¬¡è¿è¡Œ:** åŒ—äº¬æ—¶é—´ 06:00 å’Œ 17:30" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "CC.m3u" ]; then
          echo "## âœ… ç”ŸæˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ğŸ“Š æ–‡ä»¶ä¿¡æ¯**" >> $GITHUB_STEP_SUMMARY
          echo "- è¡Œæ•°: $(wc -l < CC.m3u)" >> $GITHUB_STEP_SUMMARY
          echo "- å¤§å°: $(wc -c < CC.m3u) å­—èŠ‚" >> $GITHUB_STEP_SUMMARY
          echo "- æ¸¯æ¾³å°é¢‘é“æ•°: $(grep -c 'group-title=\"å…¨ç½‘é€šæ¸¯æ¾³å°\"' CC.m3u || echo 0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ğŸ”§ é…ç½®ä¿¡æ¯**" >> $GITHUB_STEP_SUMMARY
          echo "- EPGåœ°å€: http://epg.51zmt.top:8000/e.xml" >> $GITHUB_STEP_SUMMARY
          echo "- æºåœ°å€: https://stymei.sufern001.workers.dev/" >> $GITHUB_STEP_SUMMARY
          echo "- æ’åºè§„åˆ™: å‡¤å‡°â†’NOWâ†’TVBâ†’HOYâ†’VIUTVâ†’å…¶ä»–" >> $GITHUB_STEP_SUMMARY
          echo "- è¿‡æ»¤é¢‘é“: å‡¤å‡°ç”µå½±ã€C+ã€MoMoTVã€DAZN1ã€DAZN2ã€ELEVENä½“è‚²1ã€ELEVENä½“è‚²2ã€çˆ±å¥‡è‰ºç­‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ğŸ”— ç›´é“¾åœ°å€**" >> $GITHUB_STEP_SUMMARY
          echo "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/CC.m3u" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸæäº¤
          if git log --oneline -1 | grep -q "è‡ªåŠ¨æ›´æ–°CC.m3u"; then
            echo "**âœ… å·²æäº¤åˆ°ä»“åº“**" >> $GITHUB_STEP_SUMMARY
            echo "æäº¤å“ˆå¸Œ: $(git log --oneline -1 | cut -d' ' -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**âš ï¸  æ–‡ä»¶å·²ç”Ÿæˆä½†æœªæäº¤**" >> $GITHUB_STEP_SUMMARY
            echo "åŸå› : æ— å˜åŒ–æˆ–æäº¤æƒé™é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“ æ–‡ä»¶é¢„è§ˆ**" >> $GITHUB_STEP_SUMMARY
          echo '```m3u' >> $GITHUB_STEP_SUMMARY
          head -10 CC.m3u >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥è„šæœ¬æ‰§è¡Œæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ› ï¸ æ•…éšœæ’æŸ¥ï¼ˆä»…é”™è¯¯æ—¶è¿è¡Œï¼‰
      if: failure()
      run: |
        echo "=== æ•…éšœæ’æŸ¥ä¿¡æ¯ ==="
        echo ""
        echo "1. æ–‡ä»¶ç³»ç»ŸçŠ¶æ€:"
        ls -la
        echo ""
        echo "2. GitçŠ¶æ€:"
        git status
        echo ""
        echo "3. Gité…ç½®:"
        git config --list | grep -E "user\.(name|email)"
        echo ""
        echo "4. æƒé™æ£€æŸ¥:"
        echo "å½“å‰ç”¨æˆ·: $(whoami)"
        echo "å·¥ä½œç›®å½•æƒé™:"
        ls -ld .
        echo ""
        echo "5. ç”Ÿæˆçš„CC.m3uæ˜¯å¦å­˜åœ¨:"
        if [ -f "CC.m3u" ]; then
          echo "âœ… å­˜åœ¨ï¼Œå¤§å°: $(wc -c < CC.m3u) å­—èŠ‚"
        else
          echo "âŒ ä¸å­˜åœ¨"
        fi
