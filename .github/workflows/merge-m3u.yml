name: è‡ªåŠ¨ç”ŸæˆM3U+EPG

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00
    - cron: '0 10 * * *'  # UTC 10:00 = åŒ—äº¬æ—¶é—´ 18:00
  push:
    paths:
      - 'scripts/merge_from_proxy.py'
      - '.github/workflows/merge-m3u.yml'

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: pip install requests
    
    - name: ğŸš€ ç”ŸæˆM3Uå’ŒEPG
      run: |
        echo "å¼€å§‹ç”ŸæˆM3Uå’ŒEPGæ–‡ä»¶..."
        python scripts/merge_from_proxy.py
        
        echo -e "\n=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        echo "CC.m3u: $(wc -l < CC.m3u) è¡Œ"
        echo "CC.xml: $(wc -l < CC.xml) è¡Œ"
        
        echo -e "\n=== EPGç¤ºä¾‹ ==="
        grep -A3 '<channel id=' CC.xml | head -12
    
    - name: ğŸ“¤ æäº¤æ–‡ä»¶
      run: |
        git config user.email "github-actions@users.noreply.github.com"
        git config user.name "GitHub Actions"
        
        git add CC.m3u CC.xml
        
        if git diff --cached --quiet; then
          echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° M3U+EPG [$(date +'%Y-%m-%d %H:%M')]"
          git push
        fi
    
    - name: ğŸ“Š è¾“å‡ºç»“æœ
      run: |
        echo "=== ç”Ÿæˆå®Œæˆ ==="
        echo "ğŸ“ M3Uæ–‡ä»¶: https://raw.githubusercontent.com/${{ github.repository }}/main/CC.m3u"
        echo "ğŸ“ EPGæ–‡ä»¶: https://raw.githubusercontent.com/${{ github.repository }}/main/CC.xml"
        echo "ğŸ•’ ä¸‹æ¬¡æ›´æ–°: åŒ—äº¬æ—¶é—´ 06:00 å’Œ 18:00"
