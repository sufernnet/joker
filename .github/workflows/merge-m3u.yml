name: è‡ªåŠ¨åˆå¹¶M3Uï¼ˆHKåœ¨å‰ï¼ŒTWåœ¨åï¼‰

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´ 06:00 å’Œ 18:00
  # UTCæ—¶é—´ = åŒ—äº¬æ—¶é—´ - 8å°æ—¶
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00ï¼ˆæ¬¡æ—¥ï¼‰
    - cron: '0 10 * * *'  # UTC 10:00 = åŒ—äº¬æ—¶é—´ 18:00
  
  # å½“è„šæœ¬æ›´æ–°æ—¶ä¹Ÿè§¦å‘
  push:
    paths:
      - 'scripts/merge_from_proxy.py'
      - '.github/workflows/merge-m3u.yml'

jobs:
  merge-m3u:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install requests
    
    - name: ğŸ•’ æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯
      run: |
        echo "=== æ—¶é—´ä¿¡æ¯ ==="
        echo "å½“å‰UTCæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "å½“å‰åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "å·¥ä½œæµè§¦å‘æ—¶é—´: ${{ github.event.schedule }}"
        echo "ä¸‹æ¬¡è®¡åˆ’è¿è¡Œ:"
        echo "  - UTC 22:00 (åŒ—äº¬æ—¶é—´ 06:00)"
        echo "  - UTC 10:00 (åŒ—äº¬æ—¶é—´ 18:00)"
    
    - name: ğŸš€ è¿è¡Œåˆå¹¶è„šæœ¬
      run: |
        echo "å¼€å§‹è¿è¡Œåˆå¹¶è„šæœ¬..."
        python scripts/merge_from_proxy.py
        
        echo -e "\n=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        if [ -f "CC.m3u" ]; then
          echo "âœ… CC.m3u å·²ç”Ÿæˆ"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < CC.m3u) å­—èŠ‚"
          echo "è¡Œæ•°: $(wc -l < CC.m3u)"
          echo -e "\næ–‡ä»¶ç»“æ„éªŒè¯:"
          echo "1. æ˜¯å¦æœ‰EPGä¿¡æ¯:"
          head -2 CC.m3u
          echo -e "\n2. HKé¢‘é“æ˜¯å¦åœ¨TWä¹‹å‰:"
          grep -n "# HKé¢‘é“" CC.m3u
          grep -n "# TWé¢‘é“" CC.m3u
          echo -e "\n3. HKé¢‘é“æ’åºæ£€æŸ¥:"
          grep -A2 "å‡¤å‡°ä¸­æ–‡" CC.m3u | head -3 || true
          grep -A2 "å‡¤å‡°èµ„è®¯" CC.m3u | head -3 || true
          grep -A2 "NOWæ–°é—»å°" CC.m3u | head -3 || true
        else
          echo "âŒ CC.m3u æœªç”Ÿæˆ"
          exit 1
        fi
    
    - name: ğŸ“¤ æäº¤æ–‡ä»¶
      run: |
        # é…ç½®Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥CC.m3uæ˜¯å¦å­˜åœ¨
        if [ -f "CC.m3u" ]; then
          echo "å‡†å¤‡æäº¤CC.m3u..."
          
          # æ·»åŠ æ–‡ä»¶
          git add CC.m3u
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            # æäº¤å¹¶æ¨é€
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° CC.m3u [HKæ’åºåœ¨å‰] [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… æäº¤å®Œæˆ"
          fi
        else
          echo "âŒ CC.m3uä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤"
          exit 1
        fi
    
    - name: ğŸ“Š è¾“å‡ºç»“æœ
      run: |
        echo "=== è¿è¡Œå®Œæˆ ==="
        echo "ğŸ•’ å½“å‰UTCæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ•’ å½“å‰åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“… ä¸‹æ¬¡è¿è¡Œæ—¶é—´:"
        echo "  - UTC 22:00 (åŒ—äº¬æ—¶é—´ 06:00)"
        echo "  - UTC 10:00 (åŒ—äº¬æ—¶é—´ 18:00)"
        echo "ğŸ”— æ–‡ä»¶é“¾æ¥:"
        echo "  - GitHub: https://github.com/${{ github.repository }}/blob/main/CC.m3u"
        echo "  - Raw: https://raw.githubusercontent.com/${{ github.repository }}/main/CC.m3u"
        echo "ğŸ“Š æ’åºè§„åˆ™: BB â†’ HK(å‡¤å‡°/NOWä¼˜å…ˆ) â†’ TW(å·²è¿‡æ»¤)"
