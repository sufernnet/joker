name: è‡ªåŠ¨åˆå¹¶ M3U æ–‡ä»¶

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      description:
        description: 'è¿è¡Œæè¿°'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘ M3U åˆå¹¶'
  
  # å®šæ—¶è§¦å‘ - ä¿®æ”¹è¿™é‡Œï¼
  # UTC æ—¶é—´ï¼š6:00 = åŒ—äº¬æ—¶é—´ 14:00ï¼Œ18:00 = åŒ—äº¬æ—¶é—´ 02:00ï¼ˆæ¬¡æ—¥ï¼‰
  # å¦‚æœè¦ç”¨åŒ—äº¬æ—¶é—´ï¼Œå¯¹åº” UTC æ—¶é—´éœ€å‡8å°æ—¶
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 22:00ï¼ˆåŒ—äº¬æ—¶é—´ 06:00ï¼‰
    - cron: '0 22 * * *'
    # æ¯å¤© UTC æ—¶é—´ 10:00ï¼ˆåŒ—äº¬æ—¶é—´ 18:00ï¼‰
    - cron: '0 10 * * *'
  
  # å½“è„šæœ¬æ–‡ä»¶æ›´æ–°æ—¶è§¦å‘
  push:
    paths:
      - 'scripts/merge_m3u.py'
      - '.github/workflows/merge-m3u.yml'
  
  # åˆ›å»º release æ—¶è§¦å‘
  release:
    types: [created]

jobs:
  merge-m3u:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: ğŸš€ è¿è¡Œåˆå¹¶è„šæœ¬
      run: |
        python scripts/merge_m3u.py
        
        # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶ä¿¡æ¯
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶å†…å®¹é¢„è§ˆï¼ˆå‰10è¡Œï¼‰==="
        head -20 CC.m3u
        echo "..."
        echo "=== æ–‡ä»¶ä¿¡æ¯ ==="
        wc -l CC.m3u
        ls -lh CC.m3u
    
    - name: ğŸ“ æäº¤ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        # é…ç½® Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet CC.m3u 2>/dev/null; then
          echo "ğŸ“­ æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          echo "ğŸ“¤ æäº¤æ–°ç”Ÿæˆçš„ CC.m3u"
          git add CC.m3u
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° CC.m3u [$(date +'%Y-%m-%d %H:%M')]"
          git push
        fi
    
    - name: ğŸ“Š è¾“å‡ºæ€»ç»“
      run: |
        echo "ğŸ‰ M3U åˆå¹¶å®Œæˆï¼"
        echo "ğŸ“… è¿è¡Œæ—¶é—´: $(date)"
        echo "â° ä¸‹æ¬¡è¿è¡Œ: UTC 22:00 å’Œ 10:00"
        echo "ğŸ• å¯¹åº”åŒ—äº¬æ—¶é—´: 06:00 å’Œ 18:00"
        echo "ğŸ”— æ–‡ä»¶é“¾æ¥: https://github.com/${{ github.repository }}/blob/main/CC.m3u"
        echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: $(wc -l < CC.m3u || echo 'N/A')"
