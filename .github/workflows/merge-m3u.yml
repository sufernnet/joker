name: è‡ªåŠ¨åˆå¹¶M3Uï¼ˆä½¿ç”¨Cloudflareä»£ç†ï¼‰

# ğŸ”‘ æ˜ç¡®å£°æ˜æƒé™ï¼Œé¿å… 403 & schedule é™æƒ
permissions:
  contents: write

on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ•‘å‘½æŒ‰é’®ï¼Œåƒä¸‡åˆ«åˆ ï¼‰
  workflow_dispatch:

  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´ 06:00 / 17:00
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00
    - cron: '0 9 * * *'   # UTC 09:00 = åŒ—äº¬æ—¶é—´ 17:00

  # å½“è„šæœ¬æˆ– workflow æœ¬èº«å˜åŠ¨æ—¶è§¦å‘
  push:
    paths:
      - 'scripts/merge_from_proxy.py'
      - '.github/workflows/merge-m3u.yml'

jobs:
  merge-m3u:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --no-cache-dir requests beautifulsoup4

      - name: ğŸ•’ æ˜¾ç¤ºè¿è¡Œæ—¶é—´ä¸äº‹ä»¶
        run: |
          echo "=== æ—¶é—´ä¿¡æ¯ ==="
          echo "UTC æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "å·¥ä½œæµ: ${{ github.workflow }}"

      - name: ğŸš€ è¿è¡Œåˆå¹¶è„šæœ¬
        run: |
          set -e
          python scripts/merge_from_proxy.py

          if [ ! -f "CC.m3u" ]; then
            echo "âŒ CC.m3u æœªç”Ÿæˆ"
            exit 1
          fi

          echo "âœ… CC.m3u å·²ç”Ÿæˆ"
          echo "è¡Œæ•°: $(wc -l < CC.m3u)"
          echo "å¤§å°: $(wc -c < CC.m3u) å­—èŠ‚"

      - name: ğŸ”„ åŒæ­¥è¿œç¨‹ï¼ˆrebaseï¼Œé¿å…å†²çªï¼‰
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git pull --rebase --autostash origin main

      - name: ğŸ“¤ æäº¤å¹¶æ¨é€ï¼ˆæœ‰å˜åŒ–æ‰æäº¤ï¼‰
        run: |
          if git diff --quiet CC.m3u; then
            echo "ğŸ“­ CC.m3u æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

          git add CC.m3u
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° CC.m3u [$(date -u '+%Y-%m-%d %H:%M UTC')]"
          git push origin main

      - name: ğŸ“Š è¿è¡Œæ€»ç»“
        if: always()
        run: |
          echo "=== è¿è¡Œå®Œæˆ ==="
          echo "UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "æ–‡ä»¶åœ°å€:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/CC.m3u"
