name: Fetch Taiwan News Live

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  fetch-live:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Debug directory structure
      run: |
        echo "ğŸ“ ç•¶å‰ç›®éŒ„çµæ§‹:"
        pwd
        ls -la
        echo ""
        echo "ğŸ“ scriptsç›®éŒ„:"
        ls -la scripts/ 2>/dev/null || echo "scriptsç›®éŒ„ä¸å­˜åœ¨"
    
    - name: Run crawler (ç›´æ¥åŸ·è¡Œ)
      run: |
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œçˆ¬èŸ²..."
        python scripts/youtube_crawler.py
        
        echo ""
        echo "ğŸ“ åŸ·è¡Œå¾Œæ–‡ä»¶åˆ—è¡¨:"
        ls -la *.m3u 2>/dev/null || echo "æœªæ‰¾åˆ°m3uæ–‡ä»¶"
        
        # å¦‚æœæ²’æœ‰ç”Ÿæˆåœ¨æ ¹ç›®éŒ„ï¼Œæª¢æŸ¥scriptsç›®éŒ„
        if [ ! -f "live.m3u" ]; then
          echo "æª¢æŸ¥scriptsç›®éŒ„..."
          ls -la scripts/*.m3u 2>/dev/null || echo "scriptsç›®éŒ„ä¸­ä¹Ÿæ²’æœ‰m3uæ–‡ä»¶"
        fi
    
    - name: Move M3U file if needed
      run: |
        echo "ğŸ”§ è™•ç†æ–‡ä»¶ä½ç½®..."
        
        # å¦‚æœæ–‡ä»¶åœ¨scriptsç›®éŒ„ï¼Œç§»å‹•åˆ°æ ¹ç›®éŒ„
        if [ -f "scripts/live.m3u" ]; then
          echo "ğŸ“ ç§»å‹• scripts/live.m3u åˆ°æ ¹ç›®éŒ„"
          mv scripts/live.m3u live.m3u
        fi
        
        # ç¢ºä¿æ–‡ä»¶å­˜åœ¨
        if [ -f "live.m3u" ]; then
          echo "âœ… live.m3u æ–‡ä»¶å·²æº–å‚™å¥½"
          echo "æ–‡ä»¶å¤§å°: $(wc -l < live.m3u) è¡Œ"
        else
          echo "âŒ æœªæ‰¾åˆ° live.m3u æ–‡ä»¶"
          exit 1
        fi
    
    - name: Show result details
      run: |
        echo ""
        echo "=== ğŸ“Š åŸ·è¡Œçµæœè©³ç´°ä¿¡æ¯ ==="
        echo ""
        
        if [ -f "live.m3u" ]; then
          echo "âœ… ç›´æ’­æºæ–‡ä»¶å·²ç”Ÿæˆ"
          echo ""
          
          # è¨ˆç®—é »é“æ•¸é‡
          CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
          echo "ğŸ“º é »é“ç¸½æ•¸: $CHANNEL_COUNT å€‹"
          
          # é¡¯ç¤ºæ›´æ–°æ™‚é–“
          UPDATE_TIME=$(grep 'æ›´æ–°æ™‚é–“:' live.m3u | head -1)
          echo "ğŸ• $UPDATE_TIME"
          
          # é¡¯ç¤ºé »é“åˆ—è¡¨
          echo ""
          echo "ğŸ“¡ é »é“åˆ—è¡¨:"
          echo "----------------"
          grep 'tvg-name=' live.m3u | cut -d'"' -f4 | nl
          echo "----------------"
          
          # é¡¯ç¤ºæ–‡ä»¶é ­éƒ¨
          echo ""
          echo "ğŸ“„ æ–‡ä»¶é ­éƒ¨å…§å®¹:"
          echo "----------------"
          head -20 live.m3u
          echo "----------------"
          
          # é¡¯ç¤ºè¨ªå•é€£çµ
          echo ""
          echo "ğŸŒ åŸå§‹æ–‡ä»¶è¨ªå•é€£çµ:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/live.m3u"
        else
          echo "âŒ æœªæ‰¾åˆ°ç›´æ’­æºæ–‡ä»¶"
        fi
    
    - name: Commit and push changes
      run: |
        echo "ğŸ“ æº–å‚™æäº¤åˆ°GitHub..."
        
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
        git add live.m3u scripts/youtube_crawler.py .github/workflows/auto_fetch.yml 2>/dev/null || true
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git status --porcelain | grep -q .; then
          echo "æª¢æ¸¬åˆ°æ–‡ä»¶è®Šæ›´ï¼Œæº–å‚™æäº¤..."
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # ç²å–é »é“æ•¸é‡
          if [ -f "live.m3u" ]; then
            CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            git commit -m "ğŸ“º æ›´æ–°å°ç£æ–°èç›´æ’­æº $TIMESTAMP" \
                       -m "é »é“æ•¸: $CHANNEL_COUNT å€‹" \
                       -m "ä¾†æº: YouTubeå®˜æ–¹é »é“" \
                       -m "è‡ªå‹•æ›´æ–°: æ¯30åˆ†é˜"
          else
            git commit -m "ğŸ”„ æ›´æ–°é…ç½®æ–‡ä»¶ $TIMESTAMP"
          fi
          
          git push
          echo "âœ… å·²æˆåŠŸæäº¤ä¸¦æ¨é€"
        else
          echo "ğŸ“ æ–‡ä»¶æ²’æœ‰è®ŠåŒ–ï¼Œç„¡éœ€æäº¤"
        fi
