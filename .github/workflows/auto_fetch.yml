name: Fetch CTI TV Live

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  fetch-live:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: pip install requests
    
    - name: Run crawler
      run: python youtube_crawler.py
    
    - name: Show result
      run: |
        echo ""
        echo "=== ğŸ“Š åŸ·è¡Œçµæœ ==="
        echo ""
        
        if [ -f "live.m3u" ]; then
          echo "âœ… ç›´æ’­æºæ–‡ä»¶å·²ç”Ÿæˆ"
          echo ""
          echo "ğŸ“„ æ–‡ä»¶æ ¼å¼:"
          echo "----------------"
          head -15 live.m3u
          echo "----------------"
          
          # æª¢æŸ¥æ ¼å¼
          if grep -q 'group-title="TW"' live.m3u; then
            echo ""
            echo "âœ… æ ¼å¼æ­£ç¢º: group-title=\"TW\""
          fi
          
          # æå–ä¿¡æ¯
          if grep -q 'tvg-id=' live.m3u; then
            TG_ID=$(grep 'tvg-id=' live.m3u | head -1 | cut -d'"' -f2)
            TG_NAME=$(grep 'tvg-name=' live.m3u | head -1 | cut -d'"' -f4)
            echo ""
            echo "ğŸ“º é »é“ä¿¡æ¯:"
            echo "tvg-id: $TG_ID"
            echo "tvg-name: $TG_NAME"
            echo "group-title: TW"
          fi
          
          echo ""
          echo "ğŸŒ è¨ªå•é€£çµ:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/live.m3u"
        else
          echo "âŒ æœªç”Ÿæˆç›´æ’­æºæ–‡ä»¶"
        fi
    
    - name: Commit to GitHub
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add live.m3u
        
        if git diff --cached --quiet; then
          echo "ğŸ“ æ–‡ä»¶æ²’æœ‰è®ŠåŒ–ï¼Œç„¡éœ€æäº¤"
        else
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # æå–é »é“ä¿¡æ¯ç”¨æ–¼æäº¤ä¿¡æ¯
          if [ -f "live.m3u" ]; then
            if grep -q 'tvg-name=' live.m3u; then
              CHANNEL_NAME=$(grep 'tvg-name=' live.m3u | head -1 | cut -d'"' -f4)
              git commit -m "ğŸ“º æ›´æ–°ç›´æ’­æº - $CHANNEL_NAME $TIMESTAMP" \
                         -m "æ ¼å¼: M3U with EPG" \
                         -m "group-title: TW"
            else
              git commit -m "ğŸ“º æ›´æ–°ä¸­å¤©é›»è¦–ç›´æ’­æº $TIMESTAMP" \
                         -m "æ ¼å¼: M3U with EPG"
            fi
          else
            git commit -m "ğŸ“º æ›´æ–°ç›´æ’­æº $TIMESTAMP"
          fi
          
          git push
          echo "âœ… å·²æäº¤åˆ°GitHubå€‰åº«"
        fi
