name: Fetch Taiwan News Live

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  fetch-live:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: pip install requests
    
    - name: Run crawler
      working-directory: ./scripts
      run: python youtube_crawler.py
    
    - name: Move M3U file to root
      run: |
        if [ -f "scripts/live.m3u" ]; then
          mv scripts/live.m3u live.m3u
          echo "âœ… M3Uæ–‡ä»¶å·²ç§»å‹•åˆ°æ ¹ç›®éŒ„"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°M3Uæ–‡ä»¶"
        fi
    
    - name: Show result
      run: |
        echo ""
        echo "=== ğŸ“Š åŸ·è¡Œçµæœ ==="
        echo ""
        
        if [ -f "live.m3u" ]; then
          echo "âœ… ç›´æ’­æºæ–‡ä»¶å·²ç”Ÿæˆ"
          echo ""
          echo "ğŸ“„ æ–‡ä»¶æ ¼å¼:"
          echo "----------------"
          head -15 live.m3u
          echo "----------------"
          
          # æª¢æŸ¥æ ¼å¼
          if grep -q 'group-title="TW"' live.m3u; then
            echo ""
            echo "âœ… æ ¼å¼æ­£ç¢º: group-title=\"TW\""
          fi
          
          # è¨ˆç®—é »é“æ•¸é‡
          CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
          echo ""
          echo "ğŸ“º é »é“ç¸½æ•¸: $CHANNEL_COUNT å€‹"
          
          # æå–å‰å¹¾å€‹é »é“ä¿¡æ¯
          echo ""
          echo "ğŸ“¡ é »é“åˆ—è¡¨ (å‰5å€‹):"
          echo "----------------"
          grep 'tvg-name=' live.m3u | head -5 | cut -d'"' -f4 | nl
          echo "----------------"
          
          echo ""
          echo "ğŸŒ è¨ªå•é€£çµ:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/live.m3u"
        else
          echo "âŒ æœªç”Ÿæˆç›´æ’­æºæ–‡ä»¶"
        fi
    
    - name: Commit to GitHub
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add live.m3u
        
        if git diff --cached --quiet; then
          echo "ğŸ“ æ–‡ä»¶æ²’æœ‰è®ŠåŒ–ï¼Œç„¡éœ€æäº¤"
        else
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # è¨ˆç®—é »é“æ•¸é‡
          if [ -f "live.m3u" ]; then
            CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
            git commit -m "ğŸ“º æ›´æ–°å°ç£æ–°èç›´æ’­æº $TIMESTAMP" \
                       -m "é »é“æ•¸: $CHANNEL_COUNT å€‹" \
                       -m "æ ¼å¼: M3U with EPG" \
                       -m "group-title: TW"
          else
            git commit -m "ğŸ“º æ›´æ–°ç›´æ’­æº $TIMESTAMP"
          fi
          
          git push
          echo "âœ… å·²æäº¤åˆ°GitHubå€‰åº«"
        fi
