name: Fetch Taiwan News Live

on:
  schedule:
    - cron: '*/30 * * * *'  # 每30分鐘執行一次
  workflow_dispatch:  # 手動觸發
  push:
    branches: [main]
    paths:
      - 'scripts/youtube_crawler.py'
      - '.github/workflows/auto_fetch.yml'

permissions:
  contents: write

jobs:
  fetch-live:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Debug directory structure
      run: |
        echo "📁 當前工作目錄: $(pwd)"
        echo ""
        echo "📁 目錄結構:"
        ls -la
        echo ""
        echo "📁 scripts目錄內容:"
        ls -la scripts/ || echo "scripts目錄不存在"
    
    - name: Run YouTube crawler
      id: run-crawler
      run: |
        echo "🚀 開始執行YouTube直播抓取..."
        echo ""
        
        # 確保在scripts目錄執行
        cd scripts
        
        echo "📁 當前目錄: $(pwd)"
        echo "📄 爬蟲文件: $(ls youtube_crawler.py)"
        echo ""
        
        # 執行爬蟲
        python youtube_crawler.py
        
        echo ""
        echo "📁 執行後scripts目錄:"
        ls -la *.m3u 2>/dev/null || echo "沒有找到m3u文件"
        
        # 檢查是否生成文件
        if [ -f "live.m3u" ]; then
          echo "✅ 在scripts目錄找到 live.m3u"
          echo "📄 文件行數: $(wc -l < live.m3u)"
          
          # 移動到根目錄
          cp live.m3u ../live.m3u
          echo "📁 已複製到根目錄"
        else
          echo "❌ 未在scripts目錄找到 live.m3u"
        fi
        
        # 返回根目錄
        cd ..
        
        echo ""
        echo "📁 根目錄檢查:"
        ls -la *.m3u 2>/dev/null || echo "根目錄沒有m3u文件"
    
    - name: Verify M3U file
      run: |
        echo "🔍 驗證M3U文件..."
        echo ""
        
        if [ -f "live.m3u" ]; then
          echo "✅ live.m3u 文件存在"
          echo ""
          
          # 顯示文件信息
          FILE_SIZE=$(wc -c < live.m3u)
          FILE_LINES=$(wc -l < live.m3u)
          CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
          
          echo "📊 文件統計:"
          echo "  • 文件大小: $FILE_SIZE 字節"
          echo "  • 文件行數: $FILE_LINES 行"
          echo "  • 頻道數量: $CHANNEL_COUNT 個"
          echo ""
          
          # 顯示文件頭部
          echo "📄 文件頭部內容:"
          echo "----------------------------"
          head -20 live.m3u
          echo "----------------------------"
          echo ""
          
          # 顯示頻道列表
          echo "📺 頻道列表:"
          echo "----------------------------"
          grep 'tvg-name=' live.m3u | cut -d'"' -f4 | nl -w2 -s'. '
          echo "----------------------------"
          echo ""
          
          # 顯示訪問鏈接
          echo "🌐 原始文件訪問鏈接:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/live.m3u"
          
        else
          echo "❌ 錯誤: live.m3u 文件不存在"
          echo ""
          echo "📁 當前目錄內容:"
          ls -la
          exit 1
        fi
    
    - name: Commit and push changes
      run: |
        echo "📝 準備提交到GitHub..."
        echo ""
        
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        # 添加文件
        git add live.m3u
        
        # 檢查是否有變化
        if git diff --cached --quiet; then
          echo "📝 文件沒有變化，無需提交"
        else
          echo "📝 檢測到文件變化，準備提交..."
          
          # 獲取文件信息
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          if [ -f "live.m3u" ]; then
            CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
            UPDATE_TIME=$(grep '更新時間:' live.m3u | head -1 | cut -d':' -f2-)
            
            # 生成提交信息
            COMMIT_MESSAGE="📺 更新台灣新聞直播源 $TIMESTAMP"
            COMMIT_MESSAGE+=$'\n'$'\n'"頻道數: $CHANNEL_COUNT 個"
            COMMIT_MESSAGE+=$'\n'"更新時間: $UPDATE_TIME"
            COMMIT_MESSAGE+=$'\n'"來源: YouTube官方頻道"
            COMMIT_MESSAGE+=$'\n'"group-title: 台灣新聞"
            
            echo "提交信息:"
            echo "$COMMIT_MESSAGE"
            echo ""
            
            git commit -m "$COMMIT_MESSAGE"
            git push
            echo "✅ 已成功提交並推送"
          else
            git commit -m "🔄 更新直播源配置 $TIMESTAMP"
            git push
          fi
        fi
    
    - name: Create workflow summary
      if: always()
      run: |
        echo "## 🎯 YouTube直播源更新報告" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "live.m3u" ]; then
          CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
          UPDATE_TIME=$(grep '更新時間:' live.m3u | head -1 | cut -d':' -f2- | sed 's/^ //')
          
          echo "✅ **直播源更新成功**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**📊 統計信息:**" >> $GITHUB_STEP_SUMMARY
          echo "- 頻道數量: $CHANNEL_COUNT 個" >> $GITHUB_STEP_SUMMARY
          echo "- 更新時間: $UPDATE_TIME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**📡 頻道列表:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep 'tvg-name=' live.m3u | cut -d'"' -f4 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**🌐 訪問地址:**" >> $GITHUB_STEP_SUMMARY
          echo "[https://raw.githubusercontent.com/${{ github.repository }}/main/live.m3u](https://raw.githubusercontent.com/${{ github.repository }}/main/live.m3u)" >> $GITHUB_STEP_SUMMARY
          
        else
          echo "❌ **直播源更新失敗**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "未能生成 live.m3u 文件，請檢查日誌。" >> $GITHUB_STEP_SUMMARY
        fi
