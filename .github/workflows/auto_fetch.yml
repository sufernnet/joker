name: Fetch Taiwan News Live

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  fetch-live:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Show directory structure
      run: |
        echo "=== ğŸ“ ç›®éŒ„çµæ§‹ ==="
        pwd
        ls -la
        echo ""
        echo "=== ğŸ“ scriptsç›®éŒ„ ==="
        ls -la scripts/ || echo "scriptsç›®éŒ„ä¸å­˜åœ¨"
    
    - name: Create simplified crawler in root
      run: |
        echo "ğŸ› ï¸ å‰µå»ºç°¡åŒ–ç‰ˆçˆ¬èŸ²åˆ°æ ¹ç›®éŒ„..."
        cat > simple_crawler.py << 'EOF'
#!/usr/bin/env python3
import requests
import re
import os
from datetime import datetime

HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
}

# æ¸¬è©¦å¹¾å€‹é »é“
CHANNELS = [
    {"name": "TVBS æ–°è", "channel": "@TVBSNEWS01"},
    {"name": "ä¸­å¤©æ–°è", "channel": "@ä¸­å¤©é›»è¦–CtiT"},
    {"name": "æ±æ£®æ–°è", "channel": "@newsebc"},
]

def get_live_video(channel_id):
    """å¾é »é“ç²å–ç›´æ’­å½±ç‰‡"""
    try:
        url = f"https://www.youtube.com/{channel_id}/videos"
        resp = requests.get(url, headers=HEADERS, timeout=10)
        html = resp.text
        
        # å°‹æ‰¾å½±ç‰‡ID
        match = re.search(r'"videoId":"([^"]{11})"', html)
        if match:
            video_id = match.group(1)
            # æª¢æŸ¥æ˜¯å¦ç‚ºç›´æ’­
            video_url = f"https://www.youtube.com/watch?v={video_id}"
            video_resp = requests.get(video_url, headers=HEADERS, timeout=5)
            if '"isLive":true' in video_resp.text:
                return video_id
    except:
        pass
    return None

def main():
    print("ğŸš€ é–‹å§‹æŠ“å–ç›´æ’­...")
    results = []
    
    for ch in CHANNELS:
        print(f"ğŸ” æª¢æŸ¥ {ch['name']}...")
        video_id = get_live_video(ch['channel'])
        if video_id:
            results.append({"name": ch['name'], "video_id": video_id})
            print(f"  âœ… æ‰¾åˆ°ç›´æ’­")
        else:
            print(f"  âŒ æœªæ‰¾åˆ°")
    
    # ç”ŸæˆM3U
    now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    m3u_lines = ['#EXTM3U', f'# æ›´æ–°æ™‚é–“: {now}', '']
    
    for ch in results:
        m3u_lines.append(f'#EXTINF:-1 group-title="TW",{ch["name"]}')
        m3u_lines.append(f'https://www.youtube.com/watch?v={ch["video_id"]}')
        m3u_lines.append('')
    
    m3u_content = '\n'.join(m3u_lines)
    
    # å¯«å…¥æ–‡ä»¶
    with open('live.m3u', 'w', encoding='utf-8') as f:
        f.write(m3u_content)
    
    print(f"\nâœ… ç”Ÿæˆå®Œæˆï¼å…± {len(results)} å€‹é »é“")
    print(f"ğŸ“ æ–‡ä»¶è·¯å¾‘: {os.path.abspath('live.m3u')}")

if __name__ == "__main__":
    main()
EOF
        
        echo "âœ… ç°¡åŒ–ç‰ˆçˆ¬èŸ²å‰µå»ºå®Œæˆ"
    
    - name: Run the simplified crawler
      run: |
        echo "ğŸš€ åŸ·è¡Œç°¡åŒ–ç‰ˆçˆ¬èŸ²..."
        python simple_crawler.py
        
        echo ""
        echo "ğŸ“ æª¢æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        ls -la live.m3u 2>/dev/null || echo "live.m3u ä¸å­˜åœ¨"
        
        if [ -f "live.m3u" ]; then
          echo "âœ… live.m3u å·²ç”Ÿæˆ"
          echo ""
          echo "ğŸ“„ æ–‡ä»¶å…§å®¹:"
          echo "=========="
          cat live.m3u
          echo "=========="
        fi
    
    - name: Now run the real crawler
      run: |
        echo "ğŸš€ ç¾åœ¨åŸ·è¡ŒçœŸæ­£çš„çˆ¬èŸ²..."
        
        # é¦–å…ˆè¤‡è£½åˆ°ç•¶å‰ç›®éŒ„
        cp scripts/youtube_crawler.py .
        
        # ä¿®æ”¹youtube_crawler.pyçš„è¼¸å‡ºè·¯å¾‘
        sed -i "s/output_path = .*/output_path = 'live.m3u'/" youtube_crawler.py 2>/dev/null || \
        sed -i "s/open(.*live\.m3u.*)/open('live.m3u', 'w', encoding='utf-8')/" youtube_crawler.py 2>/dev/null
        
        # åŸ·è¡Œ
        python youtube_crawler.py
        
        echo ""
        echo "ğŸ“ æª¢æŸ¥æ–‡ä»¶..."
        ls -la *.m3u
    
    - name: Verify and commit
      run: |
        echo "ğŸ” é©—è­‰æ–‡ä»¶..."
        
        if [ -f "live.m3u" ]; then
          echo "âœ… live.m3u å­˜åœ¨"
          echo "æ–‡ä»¶å¤§å°: $(wc -l < live.m3u) è¡Œ"
          echo ""
          echo "ğŸ“„ å‰5è¡Œ:"
          head -5 live.m3u
          
          # æäº¤
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add live.m3u
          
          if git diff --cached --quiet; then
            echo "ğŸ“ æ²’æœ‰è®ŠåŒ–"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "ğŸ“º æ›´æ–°ç›´æ’­æº $TIMESTAMP"
            git push
            echo "âœ… å·²æäº¤"
          fi
        else
          echo "âŒ æ²’æœ‰ç”Ÿæˆ live.m3u"
          exit 1
        fi
