name: Fetch Taiwan News Live

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  fetch-live:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Check directory structure
      run: |
        echo "üìÅ Current directory: $(pwd)"
        echo ""
        echo "üìÅ Listing files:"
        ls -la
        echo ""
        echo "üìÅ Checking scripts directory:"
        if [ -d "scripts" ]; then
          echo "‚úÖ scripts directory exists"
          ls -la scripts/
        else
          echo "‚ùå scripts directory not found"
          mkdir -p scripts
        fi
    
    - name: Run YouTube crawler
      run: |
        echo "üöÄ Starting YouTube live stream crawler..."
        echo ""
        
        # Go to scripts directory
        cd scripts
        
        echo "üìÅ Now in directory: $(pwd)"
        echo "üìÑ Checking for crawler script..."
        
        if [ -f "youtube_crawler.py" ]; then
          echo "‚úÖ Found youtube_crawler.py"
          echo ""
          echo "Running crawler..."
          echo "-------------------"
          
          # Run the crawler
          python youtube_crawler.py
          
          echo "-------------------"
          echo "Crawler execution completed"
          echo ""
          
          # Check if m3u file was created
          if [ -f "live.m3u" ]; then
            echo "‚úÖ live.m3u created in scripts directory"
            
            # Get channel count
            CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u || echo "0")
            echo "üì∫ Channels found: $CHANNEL_COUNT"
            
            # Copy to root directory
            cp live.m3u ../live.m3u
            echo "üìÅ Copied to root directory"
          else
            echo "‚ùå live.m3u not created in scripts directory"
            echo "üìÅ Files in scripts directory:"
            ls -la
          fi
          
        else
          echo "‚ùå youtube_crawler.py not found!"
          exit 1
        fi
        
        # Return to root
        cd ..
    
    - name: Check generated file
      run: |
        echo ""
        echo "üîç Checking generated file..."
        echo ""
        
        if [ -f "live.m3u" ]; then
          echo "‚úÖ live.m3u file exists"
          echo ""
          
          # Get file stats
          FILE_SIZE=$(wc -c < live.m3u)
          FILE_LINES=$(wc -l < live.m3u)
          CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
          
          echo "üìä File statistics:"
          echo "  ‚Ä¢ File size: $FILE_SIZE bytes"
          echo "  ‚Ä¢ Line count: $FILE_LINES lines"
          echo "  ‚Ä¢ Channel count: $CHANNEL_COUNT channels"
          echo ""
          
          # Show update time
          UPDATE_LINE=$(grep 'Êõ¥Êñ∞ÊôÇÈñì:' live.m3u | head -1 || echo "# Êõ¥Êñ∞ÊôÇÈñì: Not found")
          echo "üïê $UPDATE_LINE"
          echo ""
          
          # Show first 5 channels
          echo "üì∫ First 5 channels:"
          echo "-------------------"
          grep 'tvg-name=' live.m3u | head -5 | cut -d'"' -f4 | nl -w1 -s'. '
          echo "-------------------"
          echo ""
          
          # Show file preview
          echo "üìÑ File preview (first 10 lines):"
          echo "-------------------"
          head -10 live.m3u
          echo "-------------------"
          
          # Save channel count to output
          echo "channel_count=$CHANNEL_COUNT" >> $GITHUB_OUTPUT
          
        else
          echo "‚ùå ERROR: live.m3u file not found!"
          echo ""
          echo "üìÅ Current directory contents:"
          ls -la
          echo ""
          echo "üìÅ scripts directory contents:"
          ls -la scripts/
          exit 1
        fi
    
    - name: Display final result
      run: |
        echo ""
        echo "========================================"
        echo "üéâ Workflow execution completed"
        echo "========================================"
        echo ""
        
        if [ -f "live.m3u" ]; then
          CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
          UPDATE_TIME=$(grep 'Êõ¥Êñ∞ÊôÇÈñì:' live.m3u | head -1 | cut -d':' -f2- || echo "Unknown")
          
          echo "‚úÖ Successfully generated live stream file"
          echo ""
          echo "üìä Result summary:"
          echo "  ‚Ä¢ Total channels: $CHANNEL_COUNT"
          echo "  ‚Ä¢ Update time: $UPDATE_TIME"
          echo "  ‚Ä¢ File path: live.m3u"
          echo ""
          echo "üåê Raw file URL:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/live.m3u"
          
        else
          echo "‚ùå Failed to generate live stream file"
          echo ""
          echo "Possible issues:"
          echo "1. Crawler script error"
          echo "2. No live streams found"
          echo "3. File path issue"
          echo ""
          echo "Check the logs above for details"
        fi
        
        echo ""
        echo "========================================"
    
    - name: Commit and push changes
      if: success()
      run: |
        echo ""
        echo "üìù Preparing to commit to GitHub..."
        echo ""
        
        # Configure git
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        # Add the m3u file
        git add live.m3u
        
        # Check if there are changes
        if ! git diff --cached --quiet; then
          echo "üìù Changes detected, creating commit..."
          
          # Get timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Get channel count
          CHANNEL_COUNT=$(grep -c 'tvg-id=' live.m3u)
          
          # Create commit message
          COMMIT_MSG="üì∫ Update Taiwan news live streams $TIMESTAMP"
          COMMIT_MSG="$COMMIT_MSG"$'\n'"Channels: $CHANNEL_COUNT"
          COMMIT_MSG="$COMMIT_MSG"$'\n'"Source: YouTube official channels"
          COMMIT_MSG="$COMMIT_MSG"$'\n'"Auto-update: Every 30 minutes"
          
          echo "Commit message:"
          echo "$COMMIT_MSG"
          echo ""
          
          # Commit
          git commit -m "$COMMIT_MSG"
          
          # Push
          echo "Pushing to GitHub..."
          git push
          
          echo ""
          echo "‚úÖ Successfully committed and pushed"
          
        else
          echo "üìù No changes to commit"
        fi
