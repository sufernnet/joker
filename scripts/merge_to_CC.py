#!/usr/bin/env python3
"""
ä»è®¢é˜…é“¾æ¥æå–æŒ‡å®šåˆ†ç»„å¹¶ä¸æœ¬åœ°M3Uæ–‡ä»¶åˆå¹¶ï¼Œè¾“å‡ºCC.m3u
"""

import requests
import re
import sys
import os
import argparse
from pathlib import Path
from datetime import datetime  # ä¿®å¤ï¼šæ·»åŠ datetimeå¯¼å…¥

def extract_group_from_url(url, target_group_name):
    """
    ä»è®¢é˜…é“¾æ¥ä¸­æå–æŒ‡å®šåˆ†ç»„çš„å†…å®¹
    
    Args:
        url: è®¢é˜…é“¾æ¥URL
        target_group_name: è¦æå–çš„åˆ†ç»„åç§°ï¼ˆå¦‚"ğŸ”¥å…¨ç½‘é€šæ¸¯æ¾³å°"ï¼‰
    
    Returns:
        tuple: (åˆ†ç»„æ ‡é¢˜è¡Œ, é¢‘é“åˆ—è¡¨)
    """
    try:
        print(f"æ­£åœ¨ä» {url} è·å–æ•°æ®...")
        response = requests.get(url, timeout=30)
        response.raise_for_status()
        content = response.text
        
        print(f"æ•°æ®è·å–æˆåŠŸï¼Œé•¿åº¦: {len(content)} å­—ç¬¦")
        
        # æ„å»ºå®Œæ•´çš„åˆ†ç»„æ ‡é¢˜æœç´¢æ¨¡å¼
        full_target = f"{target_group_name},#genre#"
        
        print(f"æ­£åœ¨æœç´¢åˆ†ç»„: '{full_target}'")
        
        lines = content.split('\n')
        extracted_channels = []
        found_group = False
        new_group_header = None
        
        for i, line in enumerate(lines):
            line = line.strip()
            if not line:
                continue
                
            # æ£€æŸ¥æ˜¯å¦ä¸ºåˆ†ç»„æ ‡é¢˜è¡Œ
            if '#genre#' in line:
                if target_group_name in line:
                    found_group = True
                    # åˆ›å»ºæ–°çš„åˆ†ç»„æ ‡é¢˜
                    new_group_header = "å…¨ç½‘é€šæ¸¯æ¾³å°,#genre#"
                    print(f"æ‰¾åˆ°ç›®æ ‡åˆ†ç»„: {line}")
                    print(f"å°†é‡å‘½åä¸º: {new_group_header}")
                    continue
            
            # å¦‚æœå·²æ‰¾åˆ°ç›®æ ‡åˆ†ç»„ï¼Œæ”¶é›†é¢‘é“è¡Œ
            if found_group and line and ',' in line and not line.startswith('#'):
                # ç¡®ä¿æ˜¯æœ‰æ•ˆçš„é¢‘é“è¡Œï¼ˆé¢‘é“å,URLæ ¼å¼ï¼‰
                if '://' in line.split(',')[-1]:
                    extracted_channels.append(line)
                # å¦‚æœé‡åˆ°ä¸‹ä¸€ä¸ªåˆ†ç»„æ ‡é¢˜ï¼Œåœæ­¢æ”¶é›†
                elif '#genre#' in line and i > 0 and '#genre#' not in lines[i-1]:
                    break
        
        if found_group and new_group_header:
            print(f"æˆåŠŸæå–åˆ° {len(extracted_channels)} ä¸ªé¢‘é“")
            return new_group_header, extracted_channels
        else:
            # æ‰“å°æ‰€æœ‰æ‰¾åˆ°çš„åˆ†ç»„ä¾›è°ƒè¯•
            print("\næ‰€æœ‰æ‰¾åˆ°çš„åˆ†ç»„æ ‡é¢˜:")
            groups = [l for l in lines if '#genre#' in l]
            for group in groups:
                print(f"  - {group}")
            
            if groups:
                # å°è¯•ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªç›¸ä¼¼åˆ†ç»„
                for group in groups:
                    if "æ¸¯æ¾³å°" in group or "Hongkong" in group.lower() or "Taiwan" in group.lower():
                        print(f"\næ‰¾åˆ°ç›¸ä¼¼åˆ†ç»„: {group}")
                        parts = group.split(',')
                        if len(parts) > 0:
                            group_name = parts[0]
                            # ç®€å•æå–æ–¹æ³•
                            channels = []
                            collecting = False
                            for l in lines:
                                l = l.strip()
                                if l == group:
                                    collecting = True
                                    continue
                                elif collecting and '#genre#' in l:
                                    break
                                elif collecting and l and ',' in l and '://' in l.split(',')[-1]:
                                    channels.append(l)
                            return "å…¨ç½‘é€šæ¸¯æ¾³å°,#genre#", channels
            
            print(f"\né”™è¯¯: æœªæ‰¾åˆ°åŒ…å« '{target_group_name}' çš„åˆ†ç»„")
            return None, None
            
    except requests.RequestException as e:
        print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
        return None, None
    except Exception as e:
        print(f"å¤„ç†æ•°æ®æ—¶å‡ºé”™: {e}")
        return None, None

def load_local_m3u(filepath):
    """åŠ è½½æœ¬åœ°M3Uæ–‡ä»¶"""
    try:
        if not os.path.exists(filepath):
            print(f"æœ¬åœ°æ–‡ä»¶ {filepath} ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶")
            return []
        
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
        
        lines = content.strip().split('\n')
        print(f"å·²åŠ è½½æœ¬åœ°æ–‡ä»¶ {filepath}ï¼ŒåŒ…å« {len(lines)} è¡Œ")
        return lines
    except Exception as e:
        print(f"åŠ è½½æœ¬åœ°æ–‡ä»¶å¤±è´¥: {e}")
        return []

def merge_and_save(local_content, group_header, channels, output_file):
    """åˆå¹¶å†…å®¹å¹¶ä¿å­˜"""
    try:
        # å‡†å¤‡è¾“å‡ºå†…å®¹
        output_lines = []
        
        # æ·»åŠ M3Uå¤´
        output_lines.append("#EXTM3U")
        output_lines.append(f"# Generated by merge_to_CC.py")
        output_lines.append(f"# åˆå¹¶æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")  # è¿™é‡Œä½¿ç”¨datetime
        output_lines.append("")
        
        # æ·»åŠ åŸå§‹æœ¬åœ°å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
        if local_content:
            # è·³è¿‡å·²å­˜åœ¨çš„EXTM3Uå¤´
            skip_extm3u = False
            for line in local_content:
                if line.strip() == "#EXTM3U" and not skip_extm3u:
                    skip_extm3u = True
                    continue
                output_lines.append(line.rstrip())
            if local_content:  # å¦‚æœä¸æ˜¯ç©ºæ–‡ä»¶ï¼Œæ·»åŠ ç©ºè¡Œåˆ†éš”
                output_lines.append("")
        
        # æ·»åŠ æå–çš„åˆ†ç»„
        if group_header and channels:
            output_lines.append(f"# ä»¥ä¸‹ä¸ºæå–çš„åˆ†ç»„: å…¨ç½‘é€šæ¸¯æ¾³å°")
            output_lines.append(f"# æºURL: https://stymei.sufern001.workers.dev/")
            output_lines.append(group_header)
            for channel in channels:
                output_lines.append(channel)
        
        # å†™å…¥æ–‡ä»¶
        with open(output_file, 'w', encoding='utf-8', newline='\n') as f:
            f.write('\n'.join(output_lines))
        
        print(f"\nâœ… æˆåŠŸç”Ÿæˆæ–‡ä»¶: {output_file}")
        print(f"   æ€»è¡Œæ•°: {len(output_lines)}")
        if channels:
            print(f"   æ–°å¢é¢‘é“æ•°: {len(channels)}")
        
        return True
        
    except Exception as e:
        print(f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False

def main():
    """ä¸»å‡½æ•°"""
    
    parser = argparse.ArgumentParser(description='æå–è®¢é˜…é“¾æ¥åˆ†ç»„å¹¶åˆå¹¶åˆ°CC.m3u')
    parser.add_argument('--url', default='https://stymei.sufern001.workers.dev/',
                       help='è®¢é˜…é“¾æ¥URL')
    parser.add_argument('--group', default='ğŸ”¥å…¨ç½‘é€šæ¸¯æ¾³å°',
                       help='è¦æå–çš„åˆ†ç»„åç§°')
    parser.add_argument('--local', default='BB.m3u',
                       help='æœ¬åœ°M3Uæ–‡ä»¶')
    parser.add_argument('--output', default='CC.m3u',
                       help='è¾“å‡ºæ–‡ä»¶')
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("M3Uæ–‡ä»¶åˆå¹¶å·¥å…· - ç”ŸæˆCC.m3u")
    print("=" * 60)
    
    # 1. ä»URLæå–åˆ†ç»„
    group_header, channels = extract_group_from_url(args.url, args.group)
    
    if not group_header or not channels:
        print("âŒ æ— æ³•æå–æŒ‡å®šåˆ†ç»„å†…å®¹")
        # ä½†ä»ç„¶å¯ä»¥ç”Ÿæˆåªæœ‰æœ¬åœ°å†…å®¹çš„CC.m3u
        print("å°†åªä½¿ç”¨æœ¬åœ°å†…å®¹ç”ŸæˆCC.m3u")
        channels = []
    
    # 2. åŠ è½½æœ¬åœ°M3Uæ–‡ä»¶
    local_content = load_local_m3u(args.local)
    
    # 3. åˆå¹¶å¹¶ä¿å­˜
    success = merge_and_save(local_content, group_header, channels, args.output)
    
    if success:
        print("\nğŸ‰ ä»»åŠ¡å®Œæˆï¼")
        print(f"   è¾“å…¥: {args.local}")
        print(f"   è¾“å‡º: {args.output}")
        print(f"   æºURL: {args.url}")
        if channels:
            print(f"   æå–é¢‘é“: {len(channels)} ä¸ª")
        else:
            print(f"   æå–é¢‘é“: 0 ä¸ªï¼ˆåªä¿ç•™æœ¬åœ°å†…å®¹ï¼‰")
    else:
        print("\nâŒ ä»»åŠ¡å¤±è´¥")
        sys.exit(1)

if __name__ == "__main__":
    main()
